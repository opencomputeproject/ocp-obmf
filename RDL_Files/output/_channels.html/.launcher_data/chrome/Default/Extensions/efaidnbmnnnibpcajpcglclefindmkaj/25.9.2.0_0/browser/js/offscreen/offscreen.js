/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{fileUtil as e}from"../viewer/fileUtil.js";import{getActiveTasks as t,setCloseRequested as r,wrapTask as n}from"./offscreenTaskManager.js";import{offscreenConfig as a}from"./offscrenUtil.js";function o(e=5e3){let t,r;const n=new Promise(((e,n)=>{t=e,r=n}));return setTimeout((()=>{r(new Error("Operation timed out"))}),e),{promise:n,resolve:t,reject:r}}let i;const s=new URLSearchParams(window.location.search).get("env")||"prod",d="iframe#user-subscription-iframe",c="iframe#floodgate-activity-iframe",f="iframe#user-state-iframe",m="iframe#ajs-worker-iframe";let l,u;function p(e){const t=window.document.querySelector(e);t?.remove()}function g(e,t="ajs-worker-iframe"){const r=window.document.getElementById(t),n=a[s].acrobat_viewer_origin;r&&r.contentWindow.postMessage(e,n)}function w(e){if(!window.document.querySelector(d)&&e.cdnURL){const t=window.document;if(e.isCDNSignInEnabled){const t=new URL(e.signInURL);i=`${t}?main_op=fus`}else i=`${e.cdnURL}#/susi/fetchUserSubscription`;const r=t.createElement("iframe");r.setAttribute("src",i),r.setAttribute("id","user-subscription-iframe");t.getElementById("cdn-dnr-iframe").appendChild(r)}}function b(e){return new Promise(((t,r)=>{const n=window.document.querySelector(c);if(n){if("callFloodgateAPI"!==e.main_op)return void t(n);p(c)}if(e.iframeURL){const r=window.document,n=new URL(e.iframeURL);n.searchParams.append("anonUserUUID",e.anonUserUUID),i=n;const a=r.createElement("iframe");a.setAttribute("src",i),a.setAttribute("id","floodgate-activity-iframe"),a.onload=()=>{t(a)},a.onerror=e=>{t(null)};r.getElementById("cdn-dnr-iframe").appendChild(a)}else r(new Error("signInURL is not provided"))}))}function R(){0==t()?chrome.runtime.sendMessage({main_op:"closeOffscreenDocument",target:"background",tab:{id:""}}):setTimeout(R,100)}chrome.runtime.onMessage.addListener((function(e,t,r){if("offscreen"!==e.target)return!1;const c={getUserSubscriptions:n("getUserSubscriptions",w),getFileBuffer:n("getFileBuffer",(async e=>{const t=await fetch(e.fileBufferBlob),r=await t.blob(),n=await new Response(r).arrayBuffer();g({main_op:"getFileBuffer",tabId:e.tabId,fileInfo:{fileBuffer:n,docLastOpenState:e.docLastOpenState}})})),closeIframeOfUserSubscription:n("closeIframeOfUserSubscription",(()=>{p(d)})),getLinearizedRendition:n("getLinearizedRendition",(e=>{g({main_op:"getLinearizedRendition",tabId:e.tabId,pdfURL:e.pdfURL,pdfSize:e.pdfSize,docLastOpenState:e.docLastOpenState})})),getFileSize:n("getFileSize",g),rrvLayerRemoved:n("rrvLayerRemoved",(e=>{g({main_op:"rrvLayerRemoved",tabId:e.tabId})})),fgResponseFromCDN:n("fgResponseFromCDN",(async e=>{e.main_op="handleFgResponseFromCDN";await b(e)&&g({main_op:"fgResponseFromCDN",response:e.response},"floodgate-activity-iframe")})),callFloodgateAPI:n("callFloodgateAPI",(async e=>{e.main_op="callFloodgateAPI";await b(e)&&(l=o(),g({...e,main_op:"callFloodgateAPI"},"floodgate-activity-iframe"),l.promise.then((e=>{r({response:e})})).catch((e=>{r({response:void 0})})))})),getUserState:n("getUserState",(async e=>{e.main_op="getUserState";var t;await(t=e,new Promise(((e,r)=>{const n=window.document.querySelector(f);if(n)e(n);else if(t.iframeURL){const r=window.document,n=new URL(t.iframeURL);i=n;const a=r.createElement("iframe");a.setAttribute("src",i),a.setAttribute("id","user-state-iframe"),a.onload=()=>{e(a)},a.onerror=t=>{e(null)},r.getElementById("cdn-dnr-iframe").appendChild(a)}else r(new Error("iframeURL in user state detection is not found for requestId: "+t.requestId))})))&&(u=o(),g({...e},"user-state-iframe"),u.promise.then((e=>{r({response:e})})).catch((e=>{r({response:!1})})))})),createIframeToLoadAjsWorker:n("createIframeToLoadAjsWorker",(async e=>{const t=await(n=e,new Promise((e=>{const t=n.env||s;i=a[t].ajs_worker_uri+"?callingApp="+window.location.host;const r=window.document.querySelector(m);if(r)return void e(r);const o=n.rrvEnabled,d=window.document;if(o){const t=d.createElement("iframe");t.setAttribute("src",i),t.setAttribute("id","ajs-worker-iframe"),t.onload=()=>{e(t)},t.onerror=()=>{e(null)},d.getElementById("cdn-dnr-iframe").appendChild(t)}else e(null)})));var n;r({iframeLoaded:!!t})})),fetchImageBlobURL:n("fetchImageBlobURL",(async e=>{try{const t=await fetch(e.imgUrl);if(!t.ok)return void r({error:`Response not in 2xx range. Status: ${t.status}`});const n=await t.blob(),a=URL.createObjectURL(new Blob([n],{type:n.type||"application/octet-stream"}));r({blobUrl:a})}catch(e){r({error:e.message})}})),revokeImageBlobURL:n("revokeImageBlobURL",(e=>{URL.revokeObjectURL(e.blobUrl)}))};if(!c[e.main_op])return console.warn(`Unexpected message type received: '${e.main_op}'.`),!1;(async()=>{await c[e.main_op](e)})();return!0})),window.addEventListener("message",(function(t){if(t.origin!==new URL(i).origin)return;const a=t.data;"lastUserGuid"===a.type&&(a.main_op="updateSignInStatus",delete a.type);const o={userSubscriptions:n("userSubscriptions",(()=>{chrome.runtime.sendMessage({...a,target:"background",tab:{id:""}})})),updateSignInStatus:n("updateSignInStatus",(()=>{chrome.runtime.sendMessage({...a,target:"background",tab:{id:""}})})),closeOffscreenDocument:()=>{r(!0),R()},getFileBufferRange:n("getFileBufferRange",(async()=>{try{const t=await e.getFileBufferRange({url:a.pdfURL},a.range),r=await new Response(t.buffer).arrayBuffer();g({main_op:"acceptRangesBuffer",tabId:a.tabId,fileBuffer:r,rangeKey:`${a.range.start}-${a.range.end}`,fileSize:t.fileSize})}catch{g({main_op:"acceptRangesBuffer",tabId:a.tabId,fileBuffer:-1,rangeKey:`${a.range.start}-${a.range.end}`,fileSize:-1})}})),rapidRenditionResponse:n("rapidRenditionResponse",(()=>{chrome.runtime.sendMessage({...a,target:"background",tab:{id:a.tabId}})})),rapidRenditionError:n("rapidRenditionError",(()=>{chrome.runtime.sendMessage({...a,target:"background",tab:{id:a.tabId}})})),callFloodgateAPIResponse:n("callFloodgateAPIResponse",(e=>{l.resolve(e.data)})),getUserStateResponse:n("getUserStateResponse",(e=>{u.resolve(e.data)}))};o[a?.main_op]&&o[a.main_op](t)}));