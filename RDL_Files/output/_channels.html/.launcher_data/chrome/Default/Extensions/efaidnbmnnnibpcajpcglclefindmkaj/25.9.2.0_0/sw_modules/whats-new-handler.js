/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e}from"../common/local-storage.js";import{analytics as t}from"../common/analytics.js";import{loggingApi as a}from"../common/loggingApi.js";import{communicate as r}from"./communicate.js";import{floodgate as s}from"./floodgate.js";import{CACHE_PURGE_SCHEME as n}from"./constant.js";const o="whatsNewVersionCheck",c=10080,i=864e5;async function w(){try{const t=await s.hasFlag("dc-cv-whats-new",n.NO_CALL);if(e.setItem("whatsNew",!!t),!t)return void h();let r=c;r=function(e,t=c){if(!e)return t;try{const{alarmInterval:a}=JSON.parse(e)||{},r=parseInt(a,10);return Number.isFinite(r)&&r>0?r:t}catch{return t}}(s.getFeatureMeta("dc-cv-whats-new"));const i=await chrome.alarms.get(o);i&&i?.periodInMinutes===r||(await h(),chrome.alarms.create(o,{periodInMinutes:r,delayInMinutes:1}),a.info({message:"WhatsNew Alarm Created"}))}catch(e){}}async function h(){try{await chrome.alarms.get(o)&&chrome.alarms.clear(o)}catch(e){}}async function m(e){if(e&&e.name===o){if(!await s.hasFlag("dc-cv-whats-new",n.NO_CALL))return void await h();try{u()}catch(e){}}}async function u(){try{if(!await s.hasFlag("dc-cv-whats-new",n.NO_CALL))return;await async function(){try{if(!navigator.onLine)return!1;const t=e.getItem("whatsNewState")||{},a=t?.whatsNewJsonUrl;if(!a)return!1;const r=new URL(a),s=await fetch(r.toString(),{method:"GET"});if(!s.ok)throw new Error(`Failed to fetch wn.json: ${s.status}`);let n=await s.json();n=n.slice(0,13);const o=n[0];if(!o)return!1;const c=e.getItem("whatsNewState")?.lastSeenWn?.version,i=!c||c!==o.whatsNewVersion;if(i){const t=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...t,currentAvailableWN:o.whatsNewVersion})}return i}catch(e){return a.error({message:"WhatsNew VersionCheck Failed",error:e?.message}),!1}}()&&a.info({message:"WhatsNew New Version Detected"})}catch(e){}}async function l(r){try{if(!navigator.onLine)return;const o=await s.hasFlag("dc-cv-whats-new",n.NO_CALL),{whatsNewState:c={},whatsNewAutoOpen:w}=e.getItems(["whatsNewState","whatsNewAutoOpen"]);if(!0===c.disableAutoOpenByAdmin||!o)return;const h=c.currentAvailableWN,m=c.lastSeenWn;if(("tripledot"===r||"coachmark"===r)&&h||"browserStartup"===r&&h&&h!==m?.version){const s=Date.now(),n=e.getItem("installTimestamp");if("browserStartup"===r&&!m&&(n?(s-n)/i:0)<=15)return;if("browserStartup"===r&&"false"===w)return;if("browserStartup"===r&&m){const e=m.timestamp;if(e){if((s-e)/i<=25)return}}const o=function(t,r){try{const t=e.getItem("whatsNewState")?.whatsNewPageUrl;return t||(a.error({message:"No What's New URL found in servers config"}),null)}catch(e){return null}}();if(o){const a=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...a,currentWhatsNewOpenSource:r});await chrome.tabs.create({url:o,active:!0});const n=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...n,lastSeenWn:{version:h,timestamp:s}}),t.event("DCBrowserExt:WhatsNew:PageOpened",{version:h,trigger:r})}}}catch(e){}}r.registerHandlers({checkWhatsNewVersion:u,getWhatsNewData:async function(t,a,r){try{let t=e.getItem("whatsNewState")||{};const a=t.currentWhatsNewOpenSource;if(a){const{currentWhatsNewOpenSource:a,...r}=t;e.setItem("whatsNewState",r),t=r}const{appLocale:s,viewerLocale:n,locale:o}=e.getItems(["appLocale","viewer-locale","locale"]),c=t.currentAvailableWN,i=(t.lastSeenWn,s||n||o);r({success:!0,currentExtensionVersion:chrome.runtime.getManifest().version,whatsNewVersion:c,locale:i,source:a||"direct"})}catch(e){return{success:!1,error:e.message}}},openWhatsNew:({source:e})=>l(e)});export{h as clearWhatsNewVersionCheckAlarm,m as whatsNewAlarmHandler,l as checkAndOpenWhatsNewPage,w as checkAndInitialiseWhatsNewAlarm};