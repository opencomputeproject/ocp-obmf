/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as r,dcSessionStorage as n}from"../common/local-storage.js";import{loggingApi as s}from"../common/loggingApi.js";import{CACHE_PURGE_SCHEME as o,EXPRESS as a,EXPRESS_CONTEXT_MENU_ENABLED_VERBS as c}from"./constant.js";import{floodgate as i}from"./floodgate.js";import{util as l}from"./util.js";import{viewerModuleUtils as p}from"./viewer-module-utils.js";import{common as m}from"./common.js";import{expressIndexedDBScript as g}from"../common/expressindexedDB.js";import{removeExperimentCodeForAnalytics as E,setExperimentCodeForAnalytics as d}from"../common/experimentUtils.js";import{OFFSCREEN_DOCUMENT_PATH as u}from"../common/constant.js";import{sendCoiEnabledEvent as f,sendPingEventHandler as x}from"../common/util.js";import S from"./ExplicitBlocklist.js";let v=!1;const h={},I=10,b=720,w="expressMenu",_={"dc-cv-express-standalone":"EL","dc-cv-express-standalone-control":"ELC","dc-cv-express-whatsapp-hover":"EWH","dc-cv-express-whatsapp-hover-control":"EWHC","dc-cv-express-gmail-message-view":"EGM","dc-cv-express-gmail-message-view-control":"EGMC","dc-cv-express-google-image-preview-fte":"EIF","dc-cv-express-google-image-preview-fte-control":"EIFC","dc-cv-express-gdrive-native-viewer-fte":"EDF","dc-cv-express-gdrive-native-viewer-fte-control":"EDFC"},O="cleanUpExpressAssetMemoryMap",A="cleanUpExpressIndexedDB",R=864e5,M=6e5,P={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},T={[a.VERBS.EFFECTS_IMAGE]:"add-effects",[a.VERBS.CROP_IMAGE]:"crop-image",[a.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background",[a.VERBS.INSERT_OBJECT]:"insert-object",[a.VERBS.REMOVE_OBJECT]:"remove-object"},y="Response not in 2xx range.",C="Blob fetch response not in 2xx range.";async function L(e,t=!1){const r=Date.now();let n,o=e;if(t=t&&l.isBrowserVersionGreaterThan116())try{o=await async function(e){const t=`${u}?env=${m.getEnv()}`;await l.setupOffscreenDocument(t);const r=await chrome.runtime.sendMessage({main_op:"fetchImageBlobURL",target:"offscreen",imgUrl:e});if(r.error)throw new Error(r.error);return r.blobUrl}(e)}catch(e){s.error({message:"Error fetching image blob url from offscreen",error:e.toString()})}try{if(n=await fetch(o),o!==e&&(a=o,chrome.runtime.sendMessage({main_op:"revokeImageBlobURL",target:"offscreen",blobUrl:a})),!n.ok){throw new Error({message:o!==e?C:y,status:n.status})}}catch(t){if(o===e)throw t;s.error({message:"Error fetching image from offscreen blob url",error:t.toString()});try{n=await fetch(e)}catch(e){throw new Error({message:y,status:n.status})}}var a;const c=await n.blob();return new Promise(((e,t)=>{const n=new FileReader;n.readAsDataURL(c),n.onloadend=()=>{const t=n.result,s=Date.now()-r;e({base64data:t,imageDownloadTime:s})},n.onerror=t}))}function D(e){const t=["en-US","en-GB"],r=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));switch(e){case"dc-cv-express-whatsapp-hover":case"dc-cv-express-whatsapp-hover-control":case"dc-cv-express-gmail-message-view":case"dc-cv-express-gmail-message-view-control":return t.includes(r);default:return!0}}async function N(e){if(!await i.hasFlag(e))return!1;const t=i.getFeatureMeta(e);if(t)try{const e=JSON.parse(t);if(e.minExtVer&&l.verCmp(e.minExtVer,chrome.runtime.getManifest().version)>0)return!1}catch(e){}return!0}function F(e){return T[e]??"edit-image"}function G(e){return(n.getItem(a.EXPRESS_SESSIONS)||{})[e]}async function B(e,t){const r=Date.now(),s=new URL(t.url).hostname,o=e.srcUrl,c=t.id,p=e.intent,m=e.touchpoint,g=await async function(){return await N("dc-cv-express-standalone")?a.VARIANT.LOE:a.VARIANT.MODAL}(),E=l.uuid(),d=n.getItem(a.EXPRESS_SESSIONS)||{};let u=[];try{const e=JSON.parse(i.getFeatureMeta("dc-cv-express-error-handling-optimization"))??{};u=Object.keys(e).filter((t=>e[t]))}catch(e){}const x=n.getItem(a.COI_ENABLED_TABS)?.[c],S=!!x;return f(c,{domain:s,expressTouchpoint:m}),d[E]={pageDomain:s,imageURL:o,tabId:c,intent:p,touchpoint:m,variant:g,clickTimeStamp:r,errorHandlingOptimizationFlags:u,coiEnabled:S},n.setItem(a.EXPRESS_SESSIONS,d),E}async function U(e,t){"ContextMenu"!==e.touchpoint&&x();const r=await B(e,t);await j(r)}function k(e){const t=n.getItem(a.EXPRESS_SESSIONS)||{};return Object.keys(t).find((r=>{const s=t[r];return s.tabId===e&&!s.fetchedFromContentScript&&s.variant===a.VARIANT.MODAL&&(t[r].fetchedFromContentScript=!0,n.setItem(a.EXPRESS_SESSIONS,t),!0)}))}async function j(o){const c=G(o);let i;const p=c?.pageDomain;try{if(i=c.intent,c.variant===a.VARIANT.LOE){const e=c.clickTimeStamp,t=e+R;g.storeExpressAssetInfoInIndexedDB(o,c.imageURL,t,e),chrome.alarms.get(A,(e=>{e||chrome.alarms.create(A,{periodInMinutes:b})})),h[o]={bufferPromise:L(c.imageURL),ttl:Date.now()+M,clickTimeStamp:e,domain:p},chrome.alarms.get(O,(e=>{e||chrome.alarms.create(O,{periodInMinutes:I})}));const n=new URL(m.getExpressURLs().webAppUrl);n.searchParams.append("expressSessionId",o),n.searchParams.append("referrer",a.REFERRER);const s=F(c.intent);n.searchParams.append("editAction",s),n.searchParams.append("extId",function(){const e=Object.keys(P).filter((e=>P[e].includes(chrome.runtime.id)));return e.length>0?e[0]:"release"}());const i=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));n.searchParams.append("locale",i),"true"===r.getItem("adobeInternal")&&n.searchParams.append("setting-consoleLogLevel-performance","info"),chrome.tabs.create({url:n.href,active:!0})}else!function(e,t,r){let s=n.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];s.push({tabId:e,touchpoint:t,domain:r}),n.setItem(a.SESSIONS_WHERE_MODAL_LOADING,s)}(c.tabId,c?.touchpoint,p),await chrome.scripting.executeScript({target:{tabId:c.tabId},files:["content_scripts/express-content-script.js"]})}catch(r){K(c?.tabId,c?.touchpoint,p),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:i,eventContext:r.toString(),expressTouchpoint:c?.touchpoint,domain:p}),s.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+r.toString()})}}async function V(n){if(!h[n])return async function(r){let n,o,c;const i=G(r),l=await g.getExpressAssetInfoFromIndexedDB(r);if(!l)return s.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${a.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:a.RESPONSE_STATUS.FAILED,errorCode:a.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};n=l.url,o=l.clickTimeStamp;try{c=(await L(n)).base64data}catch(r){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:r.toString(),domain:i?.pageDomain,expressTouchpoint:i?.touchpoint}),s.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${r.toString()}`}),{status:a.RESPONSE_STATUS.FAILED,errorCode:a.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:o}}return{status:a.RESPONSE_STATUS.SUCCESS,buffer:c,clickTimeStamp:o}}(n);{const o=G(n)?.touchpoint,c=h[n]?.domain,i=h[n].clickTimeStamp,l=Date.now()-i;try{const{base64data:e,imageDownloadTime:t}=await h[n].bufferPromise,o=Date.now()-i;"true"===r.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+l),console.log("Image Download Time "+t),console.log("Time required to handover to express "+o));const p={imageDownloadTime:t,timeRequiredToHandoverToExpress:o,expressCommunicationReceivedTime:l,imageSize:e.length};return s.info({message:a.PERF_METRIC_LOG_MESSAGE,...p}),{status:a.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:i,domain:c}}catch(r){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:r.toString(),domain:c,expressTouchpoint:o}),s.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${r.toString()}`});const n=a.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:a.RESPONSE_STATUS.FAILED,errorCode:n,clickTimeStamp:i,domain:c}}}}function W(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow=overflowStyleBeforeExpressOpened,overflowStyleBeforeExpressOpened=void 0}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function X(){const e="true"===r.getItem("adobeInternal"),t=r.getItem("installSource");return e||"admin"!==t}async function H(){const e=X();for(const t of Object.keys(_)){const r=_[t];e&&await N(t)&&D(t)?d(r):E(r)}E("Exp_Mod"),E("Exp_Loe"),E("EC"),E("EWP"),E("EWPC"),E("EGN"),E("EGNC"),E("ECS"),E("ECSC"),E("EI2"),E("EI2C"),E("EGI"),E("EGIC"),E("EWSC"),E("EWS"),E("EWF"),E("EWFC"),E("EGF"),E("EGFC"),E("EGD"),E("EGDC"),E("EFB"),E("EFBC")}async function $(e){const t=["http://*/*","https://*/*"];if((await q(e)).enableExpressContextMenu){if(!v){v=!0;const e=z(w,l.getTranslation("expressEditImageParentContextMenu"),["image"],t);chrome.contextMenus.create({id:"poweredByAdobeExpress",parentId:e,title:l.getTranslation("expressEditImagePoweredByExpressContextMenu"),contexts:["image"],enabled:!1,documentUrlPatterns:t}),chrome.contextMenus.create({id:"separatorForExpressMenu",parentId:e,type:"separator",contexts:["image"],documentUrlPatterns:t}),c.forEach((r=>{const n=r+"ContextMenu";z(n,l.getTranslation(n),["image"],t,e)}))}const e=await i.hasFlag("dc-cv-enable-splunk-logging",o.NO_CALL);p.enableSplunk(e)}else!async function(){v&&(v=!1,chrome.contextMenus.remove("poweredByAdobeExpress"),chrome.contextMenus.remove("separatorForExpressMenu"),Object.keys(c).forEach((e=>{const t=c[e]+"ContextMenu";chrome.contextMenus.remove(t)})),chrome.contextMenus.remove(w))}()}async function q(e){let t={enableExpressContextMenu:!1,enableExpressOptionsPagePreference:!1,enableExpressTooltip:!1};const n=await i.hasFlag("dc-cv-express-context-menu")||await N("dc-cv-express-standalone"),s=await i.hasFlag("dc-cv-express-context-menu-tooltip");if(null!=e&&""!==e||null!=(e=r.getItem("express-touch-points"))&&""!==e||(e=!0),await H(),n&&X()&&(t.enableExpressOptionsPagePreference=!0,e&&"false"!==e)){t.enableExpressContextMenu=!0;const e="true"===r.getItem(a.CONTEXT_MENU_INTERACTION_DONE);t.enableExpressTooltip=!e&&s}return r.removeItem("express-context-menu-fg-enabled-analytics-logged"),r.removeItem("express-image-right-click-fg-enabled-analytics-logged"),t}function z(e,t,r,n,s){return chrome.contextMenus.create({id:e,parentId:s,title:t,contexts:r,documentUrlPatterns:n})}function J(){return["poweredByAdobeExpress","separatorForExpressMenu",...Object.keys(c).map((e=>c[e]+"ContextMenu")),w]}function Q(r){const o=function(e){let t=[],r=n.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];r=r.filter((r=>r.tabId!==e||(t.push(r),!1))),t.length>0&&n.setItem(a.SESSIONS_WHERE_MODAL_LOADING,r);return t}(r);o.forEach((r=>{const n="Tab closed before express modal opened";s.error({message:"Error executing express verb",error:n}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:n,expressTouchpoint:r.touchpoint,domain:r.domain})}))}function K(e,t,r){let s=n.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];const o=s.findIndex((n=>n.tabId===e&&n.touchpoint===t&&n.domain===r));o>-1&&(s.splice(o,1),n.setItem(a.SESSIONS_WHERE_MODAL_LOADING,s))}async function Y(){const e={enableWhatsappPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-whatsapp-preview");let n=r.getItem("express-touch-points");return n=""===n||n,await H(),t&&X()&&(e.enableExpressOptionsPagePreference=!0,n&&"false"!==n&&(e.enableWhatsappPreviewExpressMenu=!0)),r.removeItem("express-whatsapp-preview-fg-enabled-analytics-logged"),r.removeItem("express-whatsapp-preview-fg-control-enabled-analytics-logged"),e}async function Z(){const n={enableWhatsappHoverExpressMenu:!1,enableExpressOptionsPagePreference:!1},s=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));if(!["en-US","en-GB"].includes(s))return n;const o=await i.hasFlag("dc-cv-express-whatsapp-hover"),a=await i.hasFlag("dc-cv-express-whatsapp-hover-control");let c=r.getItem("express-touch-points");return c=""===c||c,await H(),o&&X()?(n.enableExpressOptionsPagePreference=!0,"true"!==r.getItem("express-whatsapp-hover-fg-enabled-analytics-logged")&&(r.setItem("express-whatsapp-hover-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_HOVER_MENU_FG_ENABLED)),c&&"false"!==c&&(n.enableWhatsappHoverExpressMenu=!0)):a&&X()&&"true"!==r.getItem("express-whatsapp-hover-fg-control-enabled-analytics-logged")&&(r.setItem("express-whatsapp-hover-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_HOVER_MENU_FG_CONTROL_ENABLED)),n}async function ee(){const e={enableGmailNVExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-gmail-native-viewer");let n=r.getItem("express-touch-points");return n=""===n||n,await H(),t&&X()&&(e.enableExpressOptionsPagePreference=!0,n&&"false"!==n&&(e.enableGmailNVExpressMenu=!0)),r.removeItem("express-gmail-native-viewer-fg-enabled-analytics-logged"),r.removeItem("express-gmail-native-viewer-fg-control-enabled-analytics-logged"),e}async function te(){const n={enableGmailMessageViewCTA:!1,enableExpressOptionsPagePreference:!1},s=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));if(!["en-US","en-GB"].includes(s))return n;const o=await i.hasFlag("dc-cv-express-gmail-message-view"),a=await i.hasFlag("dc-cv-express-gmail-message-view-control");let c=r.getItem("express-touch-points");return c=""===c||c,await H(),o&&X()?("true"!==r.getItem("express-gmail-message-view-fg-enabled-analytics-logged")&&(r.setItem("express-gmail-message-view-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_GMAIL_MESSAGE_VIEW_FG_ENABLED)),n.enableExpressOptionsPagePreference=!0,c&&"false"!==c&&(n.enableGmailMessageViewCTA=!0)):a&&X()&&"true"!==r.getItem("express-gmail-message-view-fg-control-enabled-analytics-logged")&&(r.setItem("express-gmail-message-view-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_GMAIL_MESSAGE_VIEW_FG_CONTROL_ENABLED)),n}async function re(){const e={enableGoogleImagePreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-google-image-preview");let n=r.getItem("express-touch-points");return n=""===n||n,await H(),t&&X()&&(e.enableExpressOptionsPagePreference=!0,n&&"false"!==n&&(e.enableGoogleImagePreviewExpressMenu=!0)),r.removeItem("express-google-image-preview-fg-enabled-analytics-logged"),r.removeItem("express-google-image-preview-fg-control-enabled-analytics-logged"),e}async function ne(){const e={enableGdriveNativeViewerExpressMenu:!1,enableExpressOptionsPagePreference:!1};let t=r.getItem("express-touch-points");t=""===t||t;const n=await i.hasFlag("dc-cv-express-gdrive-native-viewer");return await H(),n&&X()&&(e.enableExpressOptionsPagePreference=!0,t&&"false"!==t&&(e.enableGdriveNativeViewerExpressMenu=!0)),r.removeItem("express-gdrive-native-viewer-fg-enabled-analytics-logged"),r.removeItem("express-gdrive-native-viewer-fg-control-enabled-analytics-logged"),e}async function se(){const e={enableFacebookPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1};let t=r.getItem("express-touch-points");t=""===t||t;const n=await i.hasFlag("dc-cv-express-facebook-preview");return await H(),n&&X()&&(e.enableExpressOptionsPagePreference=!0,t&&"false"!==t&&(e.enableFacebookPreviewExpressMenu=!0)),r.removeItem("express-facebook-fg-enabled-analytics-logged"),r.removeItem("express-facebook-fg-control-enabled-analytics-logged"),e}const oe=function(){const e="abcdefghijklmnopqrstuvwxyz0123456789.-^{}()|?[]*$#<>_/\\",t={};for(let r=0;r<55;r+=1)t["k3_v[8b(j1y\\4^q0cd.gu9t>eaw6sn/rp{2i7m#z5|hfxol*?]$)-}<"[r]]=e[r];return t}();async function ae(e){const t=await S.getExpressBlockList();return t.length>0&&t.some((t=>{return function(e){const t=e.trim();if(!t||t.startsWith("#"))return null;if("/"===t[0]){const e=t.lastIndexOf("/");if(e<=0)return;const r=t.slice(1,e),n=t.slice(e+1);return new RegExp(r,n)}}((r=t,r.split("").map((e=>oe[e]||e)).join("")))?.test?.(e);var r}))}chrome.alarms.onAlarm.addListener((function(e){e&&e.name===O&&(Object.keys(h).forEach((e=>{h[e]?.ttl<Date.now()&&delete h[e]})),0===Object.keys(h).length&&chrome.alarms.clear(O))})),chrome.alarms.onAlarm.addListener((function(e){e&&e.name===A&&g.removeExpressAssetInfoFromIndexedDB().then((()=>{g.getExpressAssetCount().then((e=>{0===e&&chrome.alarms.clear(A)}))}))}));export{j as executeExpressVerb,W as closeExpress,$ as toggleExpressTouchpoints,q as isExpressContextMenuEnabled,V as getExpressAssetResponse,L as imageUrlToBase64,F as verbNameToIntent,K as removeSessionFromUnloadedExpressSessions,Q as expressModalTabCloseListener,Y as isWhatsappPreviewExpressMenuEnabled,Z as isWhatsappHoverExpressMenuEnabled,ee as isGmailNativeViewerExpressMenuEnabled,re as isGoogleImagePreviewExpressMenuEnabled,te as isGmailMessageViewExpressMenuEnabled,ne as isGdriveNativeViewerExpressMenuEnabled,se as isFacebookPreviewExpressMenuEnabled,k as getModalSessionId,G as getExpressSession,U as launchExpress,ae as isExpressDomainBlocked,J as getExpressMenuIds};