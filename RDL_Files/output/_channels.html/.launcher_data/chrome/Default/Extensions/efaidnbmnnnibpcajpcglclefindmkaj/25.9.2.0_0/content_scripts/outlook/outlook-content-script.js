/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(()=>{let t,e,o,n,r,s,c=!1;const a="outlook-acrobat-touch-point",i=()=>{const t=document.createElement("script");t.src=chrome.runtime.getURL("content_scripts/outlook/outlook-inject.js"),t.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(t)},l=()=>{const e=h(t?.config?.selectors?.title,document);return e&&e.innerText?e.innerText:""},u=async(n,s)=>{try{let a;if(n.startsWith("blob:"))a=(t=>{o?.sendAnalytics([["DCBrowserExt:Outlook:TouchPoint:BlobURL"]]);const e=o?.buildAcrobatPromotionSource("outlook_chrome","native_view");return chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(t)+"&acrobatPromotionSource="+e})(n);else{if(c)return void r?.showErrorToast();a=(e=>{const n=(t=>t&&t.includes("toolbar")?t.substring(0,t.indexOf("#toolbar=")):t)(e),r=new URL(n);r.searchParams.set("token",t.token);const s=o?.buildAcrobatPromotionSource("outlook_chrome","native_view");r.searchParams.set("acrobatPromotionSource",s);const c=r.toString();return o?.sendAnalytics([["DCBrowserExt:Outlook:TouchPoint:AttachmentURL"]]),chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(c)})(n)}const i=l();i&&(a+="&pdffilename="+encodeURIComponent(i)),window.open(a,"_blank"),o?.sendAnalytics("Enter"===s?.key?[["DCBrowserExt:Outlook:TouchPoint:EnterKeyDown"]]:" "===s?.key?[["DCBrowserExt:Outlook:TouchPoint:SpaceKeyDown"]]:[["DCBrowserExt:Outlook:TouchPoint:Clicked"]]),e?.acrobatTouchPointClicked("acrobat-outlook-fte-state")}catch(t){o?.sendErrorLog("OutlookTouchPoint","Failure in acrobatTouchPointEventHandler")}},d=e=>{const o=document.createElement("div"),n=(()=>{const t=document.createElement("img");return t.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png")),t.setAttribute("class","acrobat-icon"),t})(),r=(()=>{const e=document.createElement("span");return e.setAttribute("class","acrobat-text"),e.textContent=t?.config?.touchPointString||"Open in Acrobat",e})();return o.classList.add(a),o.setAttribute("data-is-focusable","true"),o.appendChild(n),o.appendChild(r),o.addEventListener("click",(t=>u(e,t))),o.addEventListener("keydown",(t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),u(e,t))})),o},m=()=>{const e=document.getElementsByClassName(a);if(e.length>0){const t=e[0];s?.removeFteTooltip(),t?.remove()}t.lastTabUrl="",t.lastAttachmentURL="",t.lastFileName=""},h=(t,e)=>{const n=o?.getElementListForSelectors(t,e);return n.length>0?n[0]:null},p=()=>{try{const e=h(t?.config?.selectors?.nativeViewer,document);if(e){const n=h(t?.config?.selectors?.header,e);if(n){const r=h(t?.config?.selectors?.url,e),s=l(),c=t?.lastAttachmentURL&&s===t?.lastFileName&&t?.token,i=r&&(t=>{const e=t.getAttribute("data");return"application/pdf"===t.getAttribute("type")&&e?.startsWith("blob:")})(r);if(c||i){((e,n)=>{try{const r=document.getElementsByClassName(a);if(r.length>0){const t=r[0];if(e.lastElementChild===t)return;return void e.append(t)}const s=d(n);e.append(s);const c=window.location.href;t?.lastTabUrl!==c&&(o?.sendAnalytics([["DCBrowserExt:Outlook:TouchPoint:Shown"]]),chrome.runtime.sendMessage({main_op:"outlook-touch-point-added"}),t.lastTabUrl=c)}catch(t){o?.sendErrorLog("OutlookTouchPoint","Failure in addAcrobatTouchPoint")}})(n,t?.lastAttachmentURL||r?.getAttribute("data")),t.lastFileName=s}else m()}else m()}else m()}catch(t){o?.sendErrorLog("OutlookTouchPoint","Failure in processForDOMUpdate")}},b=()=>{if(document?.body)try{const e={childList:!0,subtree:!0};n=new MutationObserver((function(){n.takeRecords(),chrome.runtime?.id?p():(n?.disconnect(),m(),t?.disconnectEventListeners())})),n.observe(document?.body,e)}catch(t){}else setTimeout(b,500)},k=()=>{chrome.runtime.onMessage.addListener((t=>{"add-fte-for-outlook-touch-point"===t?.type?s?.addFTE():"acrobatTouchPointsDisabled"===t?.content_op&&(n?.disconnect(),m())}))};chrome.runtime.sendMessage({main_op:"outlook-init"},(async n=>{n?.enableOutlookPDFTouchPoint&&(i(),(async()=>{[t,e,o,r,s]=await Promise.all([import(chrome.runtime.getURL("content_scripts/outlook/state.js")).then((t=>t.default)),import(chrome.runtime.getURL("content_scripts/gsuite/fte-utils.js")),import(chrome.runtime.getURL("content_scripts/gsuite/util.js")),import(chrome.runtime.getURL("content_scripts/outlook/outlook-error-toast-service.js")),import(chrome.runtime.getURL("content_scripts/outlook/outlook-fte-service.js"))])})().then((()=>{t.config=n,o?.sendAnalyticsOncePerMonth("DCBrowserExt:Outlook:TouchPoint:Enabled"),document.addEventListener("acrobat-outlook-token-intercept-response",(e=>{if(e?.detail?.success)c=!1,t&&(t.token=e?.detail?.data);else{c=!0;const t=e?.detail?.error||"Unknown error",n=e?.detail?.status||"No status code";o?.sendErrorLog("OutlookTouchPoint",`Token API failed - Error: ${t}, Status: ${n}`)}}),{signal:t?.eventControllerSignal}),document.addEventListener("acrobat-outlook-attachment-intercept-response",(e=>{if(e?.detail?.success)t?.lastAttachmentURL!==e?.detail?.responseUrl&&m(),t.token=e?.detail?.xToken,t.lastAttachmentURL=e?.detail?.responseUrl,t.lastFileName=e?.detail?.filename,p();else{const t=e?.detail?.error||"Unknown error",o=e?.detail?.status||"No status code",n=e?.detail?.responseUrl||"No URL";gsuiteUtil?.sendErrorLog("OutlookTouchPoint",`Attachment API failed - Error: ${t}, Status: ${o}, URL: ${n}`)}}),{signal:t?.eventControllerSignal}),k(),m(),r?.removeErrorToast(),(()=>{if(!t?.adobeCleanFontAdded){const e=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),o=new FontFace("AdobeClean-Regular",`url(${e})`);o.load().then((()=>{document.fonts.add(o)})),t.adobeCleanFontAdded=!0}})(),b(),p()})))}))})();