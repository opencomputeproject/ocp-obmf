/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e,dcSessionStorage as t}from"../../../common/local-storage.js";import{dcTabStorage as a}from"../tab-storage.js";import{util as n}from"../content-util.js";import{signInUtil as r}from"./signInUtils.js";import{privateApi as o}from"../content-privateApi.js";import{COOLDOWN_FOR_LFT_PROMPT as i,OptionPageActions as s,LOCAL_FILE_PERMISSION_URL as c,LOCAL_FTE_WINDOW as l,OptionsPageSource as d}from"../../../common/constant.js";import{indexedDBScript as m}from"../../../common/indexDB.js";import{loggingApi as g}from"../../../common/loggingApi.js";import{updateExtUserState as f,isNewUser as u,isEdgeBrowser as p,isDemoMode as h,getGenAIServiceVariant as w,getSearchParams as I,isMigrationCompleted as b}from"../../../common/util.js";import v from"./ResponseHeaders.js";import y from"./BookmarkUtils.js";import _ from"./LruUtil.js";import{analytics as S,events as L}from"../../../common/analytics.js";import{fileUtil as R}from"./fileUtil.js";import{getDefaultViewershipStatusEventParam as U,buildAcrobatPromotionSource as E}from"../../../content_scripts/gsuite/util.js";import{initializeBlobCacheCleanupAlarm as k}from"../../../content_scripts/blob-cache-cleanup.js";import{EXPERIMENT_VARIANTS_STORAGE_KEY as T}from"../../../sw_modules/constant.js";import{tempURLBufferIndexedDB as P}from"../../../common/temporaryURLBufferIndexDB.js";import{ALLOWED_IFRAME_SEARCH_PARAMS as D,ALLOWED_IFRAME_HASH_PARAMS as C}from"./iframeUrlParamsAllowlist.js";import{handlePostPDFConversionInDirectFlow as F,sendFileBufferToViewerForDirectFlow as A,isDirectFlowWithoutPreview as B,handleUpsellCloseInDirectFlow as x}from"./DirectVerb.js";await e.init(),await t.init();const M=e.getItem("appLocale"),V="acrobatPromotionSource";let O=!1;!function(){let l,N,$,W,H,j,G,z,q,J,Y,K,X,Z,Q,ee,te,ae,ne,re,oe,ie,se,ce,le,de,me="",ge=!1;const fe=chrome.runtime.getURL("viewer.html"),ue=chrome.runtime.getURL("signInHandler.html"),pe="file:",he="blob:",we=["https:","http:",pe],Ie=new Map([["gmail","gmail"],["gdrive","gdrive"],["embeddedpdf","embeddedPDF"],["outlook","outlook"],["linkedin","linkedIn"]]);let be,ve;be=new Promise((e=>ve=e)),_e({main_op:"chrome_viewer_opened",activeTabId:Se(document.location.search,"tabId")});function ye(e){const t=a.getItem("search");return new URLSearchParams(t).get(e)}function _e(e,t){return Z?(Q=Q||1,e.tabId=Q,e.mimeHandled=!0,chrome.runtime.sendMessage(e,t)):chrome.runtime.sendMessage(e,t)}function Se(e,t){return new URLSearchParams(e).get(t)||""}async function Le(){if(W=Se(document.location.search,"pdfurl"),ie=Se(document.location.search,"tabId"),se=Se(document.location.search,"aw"),le=await(async e=>{if(!e)return!1;try{const t=new URL(e),a=t.protocol;let n=-1!==we.indexOf(a);if(n=a===pe?t.pathname.toLowerCase().endsWith(".pdf"):n,a===he)if(n=await m.hasKey(`chrome-extension://${chrome.runtime.id}/${t.href}`),n)k(),ge=!0;else if(t?.origin?.includes("outlook"))return!0;return n}catch(e){return!1}})(W),de=Se(document.location.search,"acrobatPromotionWorkflow")||a.getItem("acrobatPromotionWorkflow"),de&&a.setItem("acrobatPromotionWorkflow",de),!le)return void(H=!1);ge&&(W=`chrome-extension://${chrome.runtime.id}/${W}`),function(){const e=new URLSearchParams(document.location.search),n=t.getItem("rtParams");if(n){const a=n.split(",").map((t=>e.has(t)?`&${t}=${e.get(t)}`:null)).join("")||"";t.setItem("payPalUrl",a),t.removeItem("rtParams")}e.has("dialog!dropin")&&a.setItem("dialog!dropin",e.get("dialog!dropin")),e.has("load!dropin")&&a.setItem("load!dropin",e.get("load!dropin"))}();const e=a.getItem("search");if((!e||Se(e,"pdfurl")!==W||e.length<document.location.search)&&a.setItem("search",document.location.search),$=Se(document.location.search,"pdffilename")||Se(e,"pdffilename")||Ye(W),document.title=$,!ge){const e="/"+W+location.hash;history.replaceState({},$,e)}}function Re(t,a){e.setItem(`reloadurl-${t.id}`,W);const n=new URL(W);if(function(e){(e?.searchParams?.has(V)||ye(V)?.length>0)&&g.info({message:"reloadInNativeViewer",source:e.searchParams.get(V)||ye(V),domain:e.hostname})}(n),It(n)&&!a?.includes("text/html")){const e=n?.searchParams?.get("id");window.location.href=`https://drive.google.com/file/d/${e}`}else window.location.href=W}function Ue(e=!1,t){if(Z)try{e||_e({main_op:"viewer-type",viewer:"mime-native"}),setTimeout((()=>{o.reloadWithNativeViewer({contentLength:parseInt(l)||0})}),100)}catch(e){ke("DCBrowserExt:Viewer:FallbackToNative:Failed")}else try{setTimeout((()=>{chrome.tabs.getCurrent((e=>Re(e,t)))}),500)}catch(e){ke("DCBrowserExt:Viewer:FallbackToNative:Failed")}}const Ee=t=>{try{const a=new URL(e.getItem("cdnUrl")),n=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return t===a.origin&&!!n.find((e=>e.test(t)))}catch(e){return!1}};function ke(e){const t={main_op:"analytics"};t.analytics=[[e]],_e(t)}function Te(){if(!sessionStorage.getItem("uuid-for-shortened-redirect-url")){const e=n.uuid();sessionStorage.setItem("uuid-for-shortened-redirect-url",e),sessionStorage.setItem(e,W)}return new URL(W)?.origin+"?uuid="+sessionStorage.getItem("uuid-for-shortened-redirect-url")}function Pe(){let e=W;return wt(W)&&(e=Te()),ht(W)?`${fe}?pdfurl=${encodeURIComponent(e)}&pdffilename=${encodeURIComponent(document.title)}`:W}function De(){let e,t=fe;if(Z)if(ge){const t=new URLSearchParams(window.location.search),a=t.get("pdfurl"),n=t.get("pdffilename");e="?pdfurl="+encodeURIComponent(a)+"&pdffilename="+encodeURIComponent(n)}else e="?mimePdfUrl="+encodeURIComponent(W),t=ue;else e=a.getItem("search"),e||(e="?pdfurl="+encodeURIComponent(W)),wt(W)&&(e="?pdfurl="+encodeURIComponent(Te()));return new URL(t+e)}const Ce=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write"];function Fe(t={}){if(e.getItem("csi")){const e=Pe(),a={...t,pdfUrl:e};return void r.cdnSignIn(a)}const a=De(),o=e.getItem("cdnUrl"),i=t.sign_up?1:0,s=n.generateStateCSRF(),c=e.getItem("enableCSRF"),l=JSON.stringify({touchp:t.touchpoint||"",signIn:!0,...c&&{state:s}}),d=e.getItem("theme")||"auto",m=`${o}?la=true&locale=${M||e.getItem("locale")}&theme=${d}&ru=${encodeURIComponent(a.href)}&rp=${l}&su=${i}#/susi`;chrome.tabs.update({url:m,active:!0})}function Ae(){const e={main_op:"signout",pdfUrl:Pe(),callingApp:chrome.runtime.id};r.cdnSignIn(e)}function Be(t={}){if(e.getItem("csi")){const e={...t,pdfUrl:W};return void r.cdnSignIn(e)}let n=new URL(ue);const o=t.idp_token;return n.searchParams.append("socialSignIn","true"),n.searchParams.append("mimePdfUrl",encodeURIComponent(W)),a.setItem("idp_token",o),n.href}function xe(e={}){Z?chrome.tabs.update({url:Be(e),active:!0}):r.socialSignIn(e,De(),W)}function Me(t={}){if(e.getItem("csi")){try{const e=new URL(JSON.parse(t.url));delete t.url;const a={...t,pdfUrl:Pe()},n=r.getCDNSignURL(a);e.searchParams.append("redirect_uri",n),chrome.tabs.update({url:e.href,active:!0})}catch(e){chrome.tabs.update({url:W})}return}const o=t.application||"google",i=e.getItem("viewerImsClientIdSocial"),s=e.getItem("imsURL"),c=n.uuid(),l=De();l.hash=l.hash+"signIn=true";const d=new URL(s+"/ims/authorize/v1"),m={ac:n.getAppCode(),csrf:c};a.setItem("csrf",c),d.searchParams.append("response_type","token"),d.searchParams.append("idp_flow","social.deep_link.web"),d.searchParams.append("client_id",i),d.searchParams.append("provider_id",o),d.searchParams.append("redirect_uri",l),d.searchParams.append("scope",Ce.join(",")),d.searchParams.append("locale",M||e.getItem("locale")),d.searchParams.append("state",JSON.stringify(m)),d.searchParams.append("xApiClientId",i),d.searchParams.append("xApiClientLocation ",o),chrome.tabs.update({url:d.href,active:!0})}const Ve={isSharePointURL:!1,isSharePointFeatureEnabled:!1,isFrictionlessEnabled:!0,featureFlags:[],isFillAndSignRegisteryEnabled:!1};class Oe{constructor(e){this.iframeElement=void 0,this.parentDiv=e}createIframe=e=>{const t=window.document,a=t.createElement("iframe");a.onerror=()=>{g.error({message:"cdnIframeLoadFailed"})},a.setAttribute("src",e),a.setAttribute("id","dc-view-frame"),a.setAttribute("allowfullscreen","allowfullscreen"),a.setAttribute("allow","clipboard-read; clipboard-write; local-fonts; payment;"),a.style.width="100vw",a.style.height="100vh",a.style.border="none",a.style.overflow="hidden",this.parentDiv.appendChild(a),this.iframeElement=t.getElementById("dc-view-frame")};_sendMessage=(e,t)=>{this.iframeElement&&Ee(t)&&function(e){let t=Date.now();return new Promise((function a(n,r){j&&(H||Z)?n(H||Z):e&&Date.now()-t>=e?r(new Error("timeout")):setTimeout(a.bind(this,n,r),30)}))}(1e6).then((a=>a&&this.iframeElement.contentWindow.postMessage(e,t)))};sendStartupConfigs=(a,n)=>{this._sendMessage({type:"nativeConfigs",nativeConfigs:Ve,extUrl:encodeURI(a),returnParamsUrl:t.getItem("payPalUrl"),isInstallTypeUpsell:O,gmailGDriveData:{gmailFteState:e.getItem("acrobat-gmail-fte-config"),gDriveFteState:e.getItem("acrobat-gdrive-fte-state")}},n),this.sendExperimentInfo(n)};sendFileMetaData=(e,t,a,n,r,o,i,s)=>{this._sendMessage({fileUrl:r,fileName:o,fileSize:a,acceptRanges:n,handShakeTime:t,type:e,isFrictionlessEnabled:Ve.isFrictionlessEnabled,isReloadOrBackForward:s,isMimeHandled:Z},i)};executeDirectVerb=(e,t,a,n,r,o,i,s)=>{this._sendMessage({type:e,fileBuffer:t,fileBufferSize:a,fileName:n,downLoadstartTime:r,downLoadEndTime:o,mimeType:i},s)};sendSubmitFormResponse=(e,t)=>{this._sendMessage({type:"submitForm",response:e},t)};sendRecentUrl=async(e,t,a,n=!1)=>{await chrome.extension.isAllowedFileSchemeAccess()||(t=t?.filter((e=>!e.url.startsWith("file://")))),this._sendMessage({type:"RecentUrls",permission:e,showOverlay:n,recentUrls:t},a)};sendProgress=(e,t,a,n)=>{this._sendMessage({total:t,loaded:a,type:e},n)};sendInitialBuffer=(e,t,a,n,r)=>{this._sendMessage({type:e,downLoadstartTime:t,downLoadEndTime:a,buffer:n},r)};sendBufferRanges=(e,t,a,n)=>{this._sendMessage({type:e,range:t,buffer:a},n)};preview=(e,t,n,r,o,i,s)=>{const c="true"===a.getItem("bufferFromIndexedDB");a.removeItem("bufferFromIndexedDB"),this._sendMessage({fileSize:n,type:e,fileBuffer:t,fileName:r,downLoadstartTime:o,downLoadEndTime:i,fromIndexedDB:c,isLocalBlobFile:ge},s)};openInAcrobatResponse=(e,t,a)=>{this._sendMessage({type:e,res:t},a)};postLog=(e,t,a,n,r)=>{this._sendMessage({type:e,reqId:t,message:a,error:n},r)};sendCertificateValidationResponse=(e,t)=>{this._sendMessage({type:"certificateValidationResponse",response:e},t)};sendExperimentInfo=t=>{const a=e.getItem(T);let n=Array.isArray(a)?a.sort():[];q._sendMessage({type:"experimentInfo",activeExperiments:n},t)}}function Ne(t,a){try{Y=void 0!==Y?Y:"false"!==e.getItem("logAnalytics")&&"false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),Y&&(q&&N?q.postLog("log",J,t,a,N.origin):setTimeout((()=>{q&&N&&q.postLog("log",J,t,a,N.origin)}),500))}catch(e){}}function $e(){let e;return e=Z?W:window.location.href,e}function We(){const t=$e(),n=(t.split("#")||[]).pop();if(n.indexOf("access_token=")>-1)try{const o=new URLSearchParams(n).get("access_token"),{client_id:i}=JSON.parse(window.atob(o.split(".")[1]))||{},s=e.getItem("viewerImsClientId");if([s,e.getItem("viewerImsClientIdSocial")].includes(i)){const e=a.getItem("csrf");a.removeItem("csrf");const n=r.parseCSRF(new URL(t));(!e||!n||n!==e)&&(ke("DCBrowserExt:Viewer:User:Error:NonMatchingCsrfToken:FailedToLogin"),Ae())}}catch{}}function He(t,a,n,r,o){o&&t.forEach((e=>{n.has(e)&&Ge(a,e,n.get(e))})),r&&t.forEach((t=>{""!==e.getItem(t)&&Ge(a,t,e.getItem(t))}))}function je(e){const t=e?.toLowerCase();for(const[e,a]of Ie.entries())if(t?.startsWith(e))return a;return""}function Ge(e,t,a,n=!1){if(!a)return;if(!(D.includes(t)||n&&D.some((e=>t.startsWith(e)))))return void console.error({message:`Attempt to use non-allowlisted param: ${t}`});const r=["storage"].includes(t)?2048:128,o="string"==typeof a?a:JSON.stringify(a);o.length>r&&g.warn({message:`Param value too long: ${t}`,length:a.length}),e.searchParams.append(t,o)}const ze=()=>{try{let r;r=Z&&!ge?new URLSearchParams(new URL(W).search):new URLSearchParams(window.location.search);const o=function(t){const a=e.getItem("cdnUrl");try{if("prod"===e.getItem("env"))return a;const n=t.get("ephemeralUrl");if(!n)return a;const r=new URL(n);return"https:"===r.protocol&&["stage.acrobat.adobe.com","dev.acrobat.adobe.com"].includes(r.hostname)&&r.pathname.startsWith("/ephemeral/dc-chrome-extension/")?n:a}catch(e){return console.error("Error validating ephemeral URL:",e?.message||"Unknown error"),a}}(r),i=new URL(o);if(!Ee(i.origin))return Ne("Invalid CDN URL detected","Invalid Origin"),void Ue();N||(N=i);let s=e.getItem("viewer-locale");s||(s=e.getItem("locale"));const c="false"!==e.getItem("logAnalytics"),l="false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),d=c&&l?"true":l?"optinOff":"gpoOff",m=r.get("blob-uri");h(m,W)&&(Ge(i,"blob-uri",m),Ge(i,"isDemoMode",!0),p()&&["returnURL","returnTabId"].forEach((e=>{const t=r.get(e);t&&i.searchParams.set(e,t)}))),"true"===r.get("ogap")&&Ge(i,"ogap","true"),r.get("olfs")&&Ge(i,"olfs",r.get("olfs")),Ge(i,"locale",M||s),Ge(i,"logAnalytics",d),Ge(i,"callingApp",chrome.runtime.id),Ge(i,"lfa",e.getItem("isAllowedLocalFileAccess")||"false"),Ge(i,"enableCaretMode",ae),t.getItem("signInTp")&&Ge(i,"touchp",t.getItem("signInTp")),Ge(i,"rvu",e.getItem("userState")?.rvu??null);const f=e.getItem("installType")||"update",I=e.getItem("installSource");Ge(i,"version",`${chrome.runtime.getManifest().version}:${f}`),Ge(i,"installSource",I),Ge(i,"storage",JSON.stringify(e.getItem("viewerStorage")||{})),Ge(i,"fgContextVars",JSON.stringify(e.getItem("fgContextVars")||{})),Ge(i,"tabId",ie),Ge(i,"anonUserUUID",e.getItem("anonUserUUID")),Ge(i,"evc",e.getItem("viewerComp")?"1":"0"),"true"!==ye("googlePrint")&&!0!==ee||"false"===a.getItem("googleAppsPrint")||Ge(i,"googleAppsPrint","true"),Ge(i,"lf",e.getItem("lf")?"1":"0");const v=oe.read(W);v&&(delete v.filename,delete v.lastVisited,Ge(i,"docState",JSON.stringify(v))),Ge(i,"nu",u()),Ge(i,"md",b()?"1":"0"),Ge(i,"dpt",e.getItem("isDarkPageThemeEnabled")?"1":"0");const y=t.getWithTTL("pdfMarkerAction");y&&(Ge(i,"action",y),t.removeItem("pdfMarkerAction")),i.searchParams.append("wn",e.getItem("whatsNew")?"1":"0"),Ge(i,"adminDisableGenAI","true"===e.getItem("DISABLE_GENAI_BY_ADMIN")?"1":"0"),SETTINGS.DEBUG_MODE&&Ge(i,"serVar",w());if("true"===e.getItem("adobeInternal")){const t="true"===e.getItem("betaOptOut");Ge(i,"betaOptOut",t)}let _=a.getItem("signinTouchPointData");_=JSON.parse(_||"{}"),_&&"object"==typeof _&&Object.keys(_).length&&(Ge(i,"tp",_.touchpoint),Ge(i,"acmt",_.allowCommentsInShare?"1":"0")),a.removeItem("signinTouchPointData");const S=e.getItem("env"),L=new URLSearchParams(new URL(W).search).get(V)||ye(V),R=je(L),U=L?.split("-")||[];if(U.length>1&&(i.searchParams.append("xId",U[0]),i.searchParams.append("xLoc",U[1])),L&&R)if(console.log("surface id ",R),Ge(i,"sfceId",R),a.getItem("acrobatPromotionWorkflow"))Ge(i,"sfceIdWf",de);else{const t=("true"===e.getItem(`${R}-pdf-default-viewership`)).toString();Ge(i,"aDFrSfce",t),Ge(i,"sfceDVFe","true"===e.getItem(`${R}-pdf-dv-feature-enablement-status`)),Ge(i,"aDFrSfceUsrDsbl",function(t,a){return"true"===e.getItem(`${t}-pdf-default-viewership-user-disabled`)||"gdrive_chrome-native_view-NDV"===a}(R,L))}n=i,["dialog!dropin","load!dropin"].forEach((e=>{""!==(a.getItem(e)||"")&&Ge(n,e,a.getItem(e))}));He(["analytics","logToConsole","enableLogging","frictionless","sessionId","linearization","ev","ao"],i,r,!1,!0);He(["rrv","fgRearch","isDeskTop","isAcrobat","theme","defaultOwnerShipExperiment","sessionId","ev","ao","ip","genAI","mv","pi","ks","edd","lft","fsu","dcs","egal","ots","egaf","pnb","subv2","s3d","ripe","od","kwgn","rat"],i,r,!0,!1);"prod"!==S&&["dropin!","provider!","app!","forceDisableGenAI"].forEach((e=>{r.forEach(((t,a)=>{a.startsWith(e)&&Ge(i,a,t,!0)}))}));let E=i.href;""===t.getItem("payPalUrl")||""===a.getItem("dialog!dropin")&&""===a.getItem("load!dropin")||(E+=t.getItem("payPalUrl"));let k=new URLSearchParams;const T=a.getItem("access_token");a.removeItem("access_token"),function(e,t,a){if(!a)return;if(!C.includes(t))return void console.error({message:`Attempt to use non-allowlisted hash param: ${t}`});const n=["access_token"].includes(t)?2048:128,r="string"==typeof a?a:JSON.stringify(a);r.length>n&&g.warn({message:`Hash param value too long: ${t}`,length:a.length}),e.set(t,r)}(k,"access_token",T);const P=k.toString()?`#${k.toString()}`:"",D=(e=>{new URL(e);let t=e;return e.length>8192&&g.error({message:"CDN iframe length breached threshold",iframeUrl:e}),e.length>6553.6&&g.warn({message:"CDN iframe length breached 80% limit",iframeUrl:e}),t})(`${E}${P}`);return e.setItem("lastPdfOpenTimestamp",(new Date).getTime()),D}catch(e){throw ke("DCBrowserExt:Viewer:Iframe:Creation:Failed"),e}var n},qe=(a,n,r="localStorage")=>{if(n){const o="localStorage"===r?e.getItem(a):t.getItem(a);let i;o&&o.tabsInfo?(i=o.tabsInfo,i.includes(n)||i.push(n)):i=[n],"localStorage"===r?e.setItem(a,{tabsInfo:i}):t.setItem(a,{tabsInfo:i})}},Je=()=>{try{!function(){try{let e=$e();e&&e.indexOf("#")>-1&&(r.saveAccessToken(e),r.signInAnalyticsLogging(e),r.checkSignInFromEditVerbPaywall(e),e=e.split("#")[0],Z?W=e:(window.location.hash=e,history.replaceState(null,document.title,e)))}catch(e){}}(),Z&&(ie=Q);const a=window.document.getElementById("Adobe-dc-view");Z||(l=ye("clen")||-1),q=new Oe(a),gt.removeItem("DCExt_Free_vs_Paid");const n=ze();q.createIframe(n),f(),window.addEventListener("message",(a=>{!a.data||!Ee(a.origin)||G||"hsready"!==a.data.type&&"ready"!==a.data.type||(G=!0,z=(new Date).getTime(),J=a.data.requestId,"on"===a.data.killSwitch?(ke("DCBrowserExt:Viewer:KillSwitch:Turned:On"),e.setItem("pdfViewer","false"),o.setViewerState("disabled"),e.setItem("killSwitch","on"),Z?Ue(!0):setTimeout((()=>{window.location.href=W}),200)):e.getItem("killSwitch")&&(ke("DCBrowserExt:Viewer:KillSwitch:Turned:Off"),e.removeItem("killSwitch")),t.getItem("signInTp")&&t.removeItem("signInTp"))}))}catch(e){throw Ne("Error create Iframe",e),e}};function Ye(e){if($)return $;let t=e;try{const a=e.split("?")[0].split("/").filter((e=>e.length>0)),n=a.length>0?a[a.length-1]:"untitled";t=n;const r=n.length-4;(n.length<4||n.toLowerCase().indexOf(".pdf")!==r)&&(t+=".pdf")}catch(e){Ne("Error in getFileNameFromURL",e)}return t}function Ke(e,t){return function(a){if(this.readyState==this.HEADERS_RECEIVED){if(!function(e,t){const a=e.getResponseHeader("content-type"),n=ht(t),r=e.getResponseHeader("content-disposition");if(a){const e=a.toLowerCase().split(";",1)[0].trim();if(!n&&r&&/^\s*attachment[;]?/i.test(r))return!1;if("application/pdf"===e)return!0;if("application/octet-stream"===e&&r&&/\.pdf(["']|$)/i.test(r))return!0}return!1}(e,t))return Ne("Fall back to native - not pdf from headers"),Ue(!1,e.getResponseHeader("content-type"));if(H=!0,"true"===se){const e=this.getResponseHeader("accept-ranges"),a=this.getResponseHeader("content-length");e&&"bytes"===e&&a&&Number(a)>0&&_e({main_op:"setupWorkerOffscreen",pdfURL:t,pdfSize:+a,acceptRanges:!0,tabId:ie})}}}}function Xe(e,t){let a=!1;return function(n){n.lengthComputable&&(l=n.total,e.sendProgress("progress",n.total,n.loaded,t),a||(!function(e){const t=oe.read(W)||{},a={main_op:"getFileSize",fileSize:e,tabId:ie,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(a)}(l),a=!0))}}function Ze(e,t){"PDF"===function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(e)&&(H=!0);const a=new XMLHttpRequest;a.open("GET",e),a.responseType="arraybuffer",a.onreadystatechange=function(){4===a.readyState&&(200!==a.status&&0!=a.status||(t({buffer:a.response,mimeType:a.getResponseHeader("content-type")}),et(a.response)))},a.send(null)}async function Qe(t){try{const n=a.getItem("bufferTabId"),r=wt(W)||"preview"===a.getItem("acrobatPromotionWorkflow")&&await P.hasKey(t);if(n||r){const e=n&&await m.getDataFromIndexedDB(n)||await P.getDataFromIndexedDB(t);if(e&&e.fileBuffer)return a.setItem("bufferFromIndexedDB",!!n),H=!0,{buffer:e.fileBuffer}}else{const t=e.getItem("tabIdMap");if(t){const n=(Z?await chrome.tabs.query({active:!0,currentWindow:!0}):[await chrome.tabs.getCurrent()])[0];if(n&&t[n.id]){a.setItem("bufferTabId",t[n.id]);const r=await m.getDataFromIndexedDB(t[n.id]);if(Object.keys(t).length>1?(delete t[n.id],e.setItem("tabIdMap",t)):e.removeItem("tabIdMap"),r&&r.fileBuffer)return a.setItem("bufferFromIndexedDB",!0),H=!0,{buffer:r.fileBuffer}}}}}catch(e){}return a.setItem("bufferFromIndexedDB",!1),{}}function et(e){const t=oe.read(W)||{},a=new Blob([e],{type:"application/pdf"}),n={main_op:"getFileBuffer",fileBufferBlob:URL.createObjectURL(a),tabId:ie,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(n)}async function tt(e){const t=wt(W),a=B();if(t||a){const t=(await chrome.tabs.getCurrent())?.id;try{await P.storeInIndexedDB(e,t)}catch(e){}}}function at(e,t,a){return new Promise(((n,r)=>{const o=W;if(o.startsWith("file://"))return void Ze(o,n);const i=new XMLHttpRequest;i.open("GET",o),i.responseType="arraybuffer",t&&i.setRequestHeader("If-Range","randomrange"),i.onreadystatechange=Ke(i,o),i.onprogress=Xe(e,a),i.onload=()=>{if(i.status>=200&&i.status<400){const e={buffer:i.response,mimeType:i.getResponseHeader("content-type"),downLoadEndTime:(new Date).getTime()};if(B())return e.pdffilename=$,H=!0,void n(e);n(e),et(i.response),tt(i.response)}else{const e={status:i.status,statusText:i.statusText};r({message:"Invalid response fetching content",error:e})}},i.onerror=e=>{ge?m.getFileByHash(W).then((async e=>{if(e)H=!0,l=e.byteLength,n({buffer:e,mimeType:"application/pdf",downLoadEndTime:(new Date).getTime(),fileSize:e.byteLength});else{g.info({message:"User tried opening blob file after expiry"});const e=chrome.runtime.getURL("browser/js/viewer/sessionExpired.html");chrome.tabs.update({url:e})}})).catch((e=>{r({message:"Error to get file contents from indexedDB",error:e})})):r({message:"Error to download file contents",error:e})},i.ontimeout=e=>{r({message:"Timeout to download file contents",error:e})},i.send()}))}function nt(e,t){ke(`DCBrowserExt:Viewer:SignIn:AdobeYolo:${e}:clicked`),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var t=e[0]&&e[0].id;qe("adobeYoloTabsInfo",t,"sessionStorage")})),_e({main_op:"launchJumpUrl",details:{source:e,userGuid:t}},(t=>{q._sendMessage({type:"adobeYoloJumpResponse",response:t,source:e},N.origin)}))}function rt(e,t,...a){Z?m.storeBufferAndCall(e,t,Q,...a):chrome.tabs.getCurrent((function(n){m.storeBufferAndCall(e,t,n.id,...a)}))}function ot(e){q._sendMessage({type:"redirectToAcrobatWeb",response:e},N.origin)}function it(){Z?chrome.tabs.reload(Q):chrome.tabs.getCurrent((e=>{chrome.tabs.reload(e.id)}))}function st(r,l){switch(l.data.main_op){case"processPreviewPostPDFConversion":!async function(e){await tt(e.data.buffer),de=null,F(e,fe,W)}(l);break;case"open_in_acrobat":case"fillsign":!async function(t,a){const r={main_op:"open_in_acrobat"};if("fillsign"===a.data.main_op?r.paramName="FillnSign":a.data.paramName&&(r.paramName=a.data.paramName),r.url=a.data.url,r.click_context="pdfviewer",r.timeStamp=Date.now(),r.filename=a.data&&a.data.filename,a.data.fileBuffer){const e=new Blob([a.data.fileBuffer],{type:"application/pdf"});r.dataURL=URL.createObjectURL(e)}if(te=function(e){"fillsign"===a.data.main_op?t.openInAcrobatResponse("FILLSIGN_IN_DESKTOP_APP",e,a.origin):t.openInAcrobatResponse("OPEN_IN_DESKTOP_APP",e,a.origin),Ne(`Open In Acrobat - (${a.data.main_op}) response- ${e}`)},e.getItem("isSharepointFeatureEnabled"))if(Ve.isSharePointURL)r.workflow_name="SharePoint",r.isSharePointURL=!0,_e(r,te);else{const e=await n.checkForSharePointURL(r.url);r.isSharePointURL=e,e&&(r.workflow_name="SharePoint"),_e(r,te)}else _e(r,te)}(r,l);break;case"complete_conversion":ke("DCBrowserExt:Viewer:Verbs:Conversion:Redirection"),function(e){const t={};t.main_op=e.data.main_op,t.conversion_url=decodeURIComponent(e.data.conversion_url),t.timeStamp=Date.now(),_e(t)}(l);break;case"updateLocale":ke("DCBrowserExt:Viewer:User:Locale:Updated"),e.setItem("viewer-locale",l.data.locale),_e({main_op:"localeChange",locale:l.data.locale}),chrome.tabs.reload();break;case"setInitialLocale":let p=!1;e.getItem("viewer-locale")||(p=!0,e.setItem("viewer-locale",l.data.locale),ke("DCBrowserExt:Viewer:User:Locale:Initial")),l.data.reloadReq&&p&&chrome.tabs.reload();break;case"error-sign-in":!function(e){const t=n.uuid();a.setItem("csrf",t);const r=new URL(e),o=De();o.hash=o.hash+`state=${t}&signInError=true`,r.searchParams.set("redirect_uri",o),chrome.tabs.update({url:r.href,active:!0})}(l.data.url);break;case"deleteViewerLocale":e.getItem("viewer-locale")&&(e.removeItem("viewer-locale"),chrome.tabs.reload());break;case"signin":ke("DCBrowserExt:Viewer:Ims:Sign:In"),a.setItem("signInSource",l.data.source),a.setItem("signinTouchPointData",JSON.stringify({touchpoint:l.data.tp,allowCommentsInShare:l.data.allowCommentsInShare})),ke(`DCBrowserExt:Viewer:Ims:Sign:In:${l.data.source}`),rt(l.data.fileBuffer,Fe,l.data);break;case"googleSignIn":ke("DCBrowserExt:Viewer:Ims:Sign:In"),ke(`DCBrowserExt:Viewer:Ims:Sign:In:${l.data.source}`),a.setItem("signInSource",l.data.source),rt(l.data.fileBuffer,Me,l.data);break;case"signup":ke("DCBrowserExt:Viewer:Ims:Sign:Up"),a.setItem("signUpSource",l.data.source),ke(`DCBrowserExt:Viewer:Ims:Sign:Up:${l.data.source}`),rt(l.data.fileBuffer,Fe,l.data);break;case"reload_viewer":chrome.tabs.reload();break;case"reload_current_tab":it();case"upsell_event":!function(e){if(e&&e.url){const a=new URL(decodeURIComponent(e.url));e.returnUrlParams&&t.setItem("rtParams",e.returnUrlParams.toString()),"_blank"===e.target?chrome.tabs.create({url:a.href,active:!0}):chrome.tabs.update({url:a.href,active:!0})}}(l.data);break;case"upsell_remove_urlParams":t.removeItem("rtParams"),t.removeItem("payPalUrl"),a.removeItem("dialog!dropin"),a.removeItem("load!dropin");break;case"fetchLocalRecents":const h=new URL(e.getItem("cdnUrl")).origin;if(l.data.fetchRecents){const e=l.data.showOverlay;!async function(e,t,a=!1){const n=oe.getAllItems();e.sendRecentUrl(!0,n,t,a)}(q,h,e)}else q.sendRecentUrl(!0,null,h);break;case"socialSignIn":ke("DCBrowserExt:Viewer:Ims:Sign:In"),ke(`DCBrowserExt:Viewer:Ims:Sign:In:${l.data.source}`),a.setItem("signInSource",l.data.source),rt(l.data.fileBuffer,xe,l.data);break;case"openRecentFileLink":const w={};w.main_op=l.data.main_op,w.recent_file_url=decodeURIComponent(l.data.recent_file_url),w.file_name=l.data.file_name,_e(w);break;case"updateCurrentURL":!async function(e){const{redirectURL:t,copyToClipboard:a}=e;if(a)try{await navigator.clipboard.writeText(a)}catch(e){}const n=Z?Q:(await chrome.tabs.getCurrent())?.id;chrome.tabs.update(n,{url:t})}(l.data);break;case"saveFileBufferAndReload":case"saveFileBufferAndReload":rt(l.data.fileBuffer,it);break;case"userSubscriptionData":if(Z){const e={};e.eventType=l.data.main_op,e.userSubscriptionData=l.data.userSubscriptionData,e.data=l.data,e.main_op=l.data.main_op;_e(e,(function(e){e&&"showUninstallPopUp"===e.main_op&&q._sendMessage({type:"showUninstallPopUp"},N.origin)}))}break;case"uninstall":Z&&_e({main_op:"uninstall",defaultUrl:W});break;case"submit_form":fetch(l.data.resource,l.data.options).then((e=>{q.sendSubmitFormResponse(e.ok,l.origin)})).catch((()=>{q.sendSubmitFormResponse(!1,l.origin)}));break;case"ownerShipExperimentShown":e.removeItem("defaultOwnerShipExperiment");break;case"openAcrobatOptions":e.setItem("optionsPageSource",d.VIEWER_PREFERENCES),chrome.runtime.openOptionsPage(),ke(`DCBrowserExt:Viewer:ManagePref:clicked:${l.data.source}`);break;case"openOnboardingTutorialFile":const I={};I.main_op=l.data.main_op,I.onboardingDemoFileURL=l.data.onboardingDemoFileURL,I.blobParam=l.data.blobParam,I.pdfURL=l.data.pdfURL,_e(I);break;case"returnToYourFile":const b={};b.main_op=l.data.main_op,b.returnTabId=l.data.returnTabId,b.returnURL=l.data.returnURL,_e(b);break;case"openLocalFileThoughFilePicker":!async function(e,t,a,n,r,o){m.storeFileByHash(t,`chrome-extension://${chrome.runtime.id}/${n}`).then((()=>{const t={};t.main_op=e,t.file_name=a,t.fileURL=n,t.openGenAIAssistantPanel=r,t.openLocalFileSource=o,_e(t)}))}(l.data.main_op,l.data.fileBuffer,l.data.file_name,l.data.fileURL,l.data.openGenAIAssistantPanel,l.data.openLocalFileSource);break;case"openExtensionSettings":if("pinToolbar"===l.data.action)chrome.tabs.query({active:!0,currentWindow:!0},(function(e){const t=e[0];n.openExtensionSettingsInWindow({tab:t,action:l.data.action})}));else{const t=e.getItem("openSettingsInWindow");t?chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const a=t[0];e.setItem("lastOpenTabId",a.id),n.openExtensionSettingsInWindow({tab:a,action:l.data.action})})):chrome.tabs.create({url:c,active:!0}),S.event(L.LOCAL_FILE_ACCESS_TOUCHPOINT_SETTINGS_OPENED,{VARIANT:t?"InWindow":"InTab"}),e.setWithTTL("LocalFileAccessTouchpointsFromViewer",!0,i),"localFileAccessBannerChallenger"===l.data.variant?e.setWithTTL("LocalFileAccessBannerChallengerTouchpointsFromViewer",!0,i):"localFileAccessBannerControl"===l.data.variant&&e.setWithTTL("LocalFileAccessBannerControlTouchpointsFromViewer",!0,i),_e({main_op:"triggerBufferSave"})}break;case"encryptedWriteFile":({secureString:me}=l.data),mt(document.title);break;case"launchJump":rt(l.data.fileBuffer,nt,l.data.source,l.data.userGuid);break;case"saveAsEvent":!async function(e){try{if(ke("DCBrowserExt:Viewer:SaveToMyComputer:"+(re?"fileHandlerExist":"fileHandlerNotExist")),re)ce=!1;else{const t={suggestedName:`${e.fileName}.pdf`,types:[{description:"PDF file",accept:{"application/pdf":[".pdf"]}}]};re=await window.showSaveFilePicker(t),ce=!0,mt(re?.name)}q._sendMessage({type:"newSaveToLocalResponse",newAsset:ce,updatedFileName:re?.name},N.origin)}catch(e){re=null,Ne("Save As Handler Error",e),q._sendMessage({type:"newSaveToLocalResponse",error:e},N.origin)}}(l.data);break;case"downloadFile":!async function(e){let t=null;try{let a=e.fileUrl;const n=e.fileName||$||"untitled";if(!a){const n=new Blob([e.fileBuffer],{type:"application/pdf"});t=URL.createObjectURL(n),a=t}await chrome.downloads.download({url:a,conflictAction:"uniquify",saveAs:!0,filename:e?.fileNameWithExtension?e?.fileNameWithExtension:`${n}.pdf`}),g.info({message:"File downloaded",url:a,fileName:n,fileNamefromViewer:e.fileName})}catch(e){Ne("downloadFile error",e),q._sendMessage({type:"downloadFileError"},N.origin)}finally{t&&URL.revokeObjectURL(t)}}(l.data);break;case"rememberSaveLocationPreference":!function(t){let a="";t.cloudStorage&&!e.getItem("selectedSaveLocationPreference")?a="PreferenceMigrationSuccess":t.cloudStorage||(a="SaveDialogRememberMe");a&&ke(`DCBrowserExt:Viewer:ChangeSaveLocationPreference:${a}`);(!t.cloudStorage||t.cloudStorage&&!e.getItem("selectedSaveLocationPreference"))&&(e.setItem("saveLocation",t.saveLocation),e.setItem("selectedSaveLocationPreference",!0),_e({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"saveLocationPreferenceTitle",toggleVal:t.saveLocation}))}(l.data);break;case"appRenderingDone":Ut();break;case"saveFileBuffer":rt(l.data.fileBuffer);break;case"deleteFileBuffer":const v=a.getItem("bufferTabId");v&&m.deleteDataFromIndexedDB(v),a.removeItem("bufferTabId");case"appRenderingDone":Ut();break;case"writeToLocalSavedFile":!async function(e){try{const t=await re.createWritable();await t.write(e.fileBuffer),await t.close(),q._sendMessage({type:"newSaveToLocalResponse",newAsset:ce,updatedFileName:re?.name,isFileWriteStage:!0},N.origin)}catch(e){re=null,Ne("Write to Local File Error",e),q._sendMessage({type:"newSaveToLocalResponse",error:e,isFileWriteStage:!0},N.origin)}}(l.data);break;case"bookmarkWeb":y(l.data.url,ot,ke);break;case"updateDocumentViewState":!function(e){const{documentViewState:t}=e;oe.writeAndSyncWithHistory(W,t)}(l.data);break;case"validateEdgeCertificateForDigitalSignature":o.validateCertificate(l.data).then((e=>q.sendCertificateValidationResponse(e,l.origin)));break;case"documentViewThemeChange":!function(t){e.getItem("theme")!==t.data&&(e.setItem("theme",t.theme),_e({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"appearancePrefTitle",toggleVal:t.theme}));e.getItem("isDarkPageThemeEnabled")!==t.isDarkPageThemeEnabled&&e.setItem("isDarkPageThemeEnabled",t.isDarkPageThemeEnabled)}(l.data);break;case"enableGenAIFeaturesToggledFromViewer":u=l.data,e.getItem("egaf")!==u.isEnabled&&(e.setItem("egaf",u.isEnabled.toString()),_e({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"enableGenAIFeaturesTitle",toggleVal:u.isEnabled}));break;case"genAIEligible":!function(t){e.setItem("genAIEligible",t?.isEligible?.toString()),ve(t?.isEligible||!1)}(l.data);break;case"rrvLayerRemoved":chrome.runtime.sendMessage({main_op:"rrvLayerRemoved",tabId:l.data.tabId,target:"offscreen"});break;case"setFloodgateResponseFromViewer":chrome.runtime.sendMessage({main_op:"handleViewerFloodgateResponse",fgResponse:l.data.fgResponse});break;case"getSignedInCachedffResponse":f=l.data.userId,q._sendMessage({type:"signedInCachedffResponse",ffResponse:e.getItem(`ffResponse_${f}`)||"{}"},N.origin);break;case"changeDefaultViewershipForSurface":chrome.runtime.sendMessage({...l.data});break;case"openWhatsNew":_e({main_op:"openWhatsNew",source:l.data.source});break;case"sendAnalytics":ke(l?.data?.event);break;case"openCollectionTab":chrome.runtime?.sendMessage({...l.data});break;case"upsell_dialog_close":x(l)}var f,u}function ct(e){try{const t=new TextDecoder("utf-8").decode(e.buffer);let a=!1;-1!=t.indexOf("Linearized 1")?a=!0:-1!=t.indexOf("Linearized")&&ke("DCBrowserExt:Viewer:Linearization:Linearized:Version:Other"),q._sendMessage({type:"Linearization",linearized:a},N.origin)}catch(e){ke("DCBrowserExt:Viewer:Linearization:Linearized:Detection:Failed"),Ne("Linearization Detection failed",e)}}function lt(t,a,n,r){n.then((n=>{const o=n.downLoadEndTime,i=n.buffer;n.buffer.byteLength;t.preview("preview",i,l,$,r,o,a.origin),q._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},N.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&q._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},N.origin)})).catch((e=>(ke("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),Ue()))).finally((()=>{e.removeItem("sessionStarted")}))}class dt{constructor(){this.request={main_op:"analytics"}}analytics=e=>{this.request.analytics||(this.request.analytics=[]),this.request.analytics.push([e])};sendAnalytics=()=>{_e(this.request)}}function mt(e){e&&(document.title=e+me)}const gt={setItem:(t,a,n)=>{const r=n?"viewerStorage":"viewerStorageAsync",o=e.getItem(r)||{};o[t]=a,e.setItem(r,o)},removeItem:(t,a=null)=>{if(null!==a){const n=a?"viewerStorage":"viewerStorageAsync",r=e.getItem(n)||{};delete r[t],e.setItem(n,r)}else{const a=e.getItem("viewerStorage")||{},n=e.getItem("viewerStorageAsync")||{};delete a[t],delete n[t],e.setItem("viewerStorage",a),e.setItem("viewerStorageAsync",n)}}};function ft(t,n,r,o){return i=>{try{if(i.data&&i.origin&&Ee(i.origin)&&(e=>{try{return e&&e.source&&e.source.top.location.origin==="chrome-extension://"+chrome.runtime.id}catch(e){return!1}})(i)){if(i.data.main_op)return st(t,i);switch(i.data.type){case"ready":if(Z?async function(t,n,r,o){let i=new dt;j=!0;let s=W;if(ge){const e=W.substring(W.indexOf("blob"));s=fe+"?pdfurl="+encodeURIComponent(e)+"&pdffilename="+encodeURIComponent($)}document.title=$;const c=ne.getHeaderValue("accept-ranges"),d=!a.getItem("bufferTabId")&&c&&"bytes"===c.toLowerCase()?"true":"false";St(),t.sendFileMetaData("metadata",z,l,d,s,$,n.origin,!1),yt(),r&&r.then((e=>{t.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,n.origin),ct(e)})).catch((e=>{t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin),i.analytics("DCBrowserExt:Viewer:Error:Linearization:InitialBufiled")})),e.removeItem("isReload"),e.removeItem("isBackForward");const m=window.performance&&window.performance.timing&&window.performance.timing.navigationStart,g=Qe(),f=await g;if(ge){const a=new URL(e.getItem("cdnUrl"));lt(t,n,at(q,!1,a.origin),m)}else f.buffer?lt(t,n,g,m):(fetch(o.streamUrl).then((e=>{let a=0;return new Response(new ReadableStream({start(r){const o=e.body.getReader();!function e(){o.read().then((({done:o,value:i})=>{o?r.close():(a+=i.byteLength,t.sendProgress("progress",l,a,n.origin),r.enqueue(i),e())})).catch((e=>{r.error(e)}))}()}}))})).then((e=>e.arrayBuffer())).then((a=>{l=a.byteLength,et(a),t.preview("preview",a,a.byteLength,$,m,(new Date).getTime(),n.origin),q._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},n.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&q._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},n.origin)})).catch((e=>(i.analytics("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),Ue()))),i.sendAnalytics());Ne("Viewer loaded")}(t,i,r,n):function(e,t,n,r,o){j=!0;let i=W;if(ge){const e=W.substring(W.indexOf("blob"));i=fe+"?pdfurl="+encodeURIComponent(e)+"&pdffilename="+encodeURIComponent($)}const s=!a.getItem("bufferTabId")&&ye("chunk")||"false",c=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("reload"),d=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("back_forward");St(),e.sendFileMetaData("metadata",z,l,s,encodeURI(i),$,t.origin,c||d),yt(),n?n.then((a=>{e.sendInitialBuffer("initialBuffer",a.startTime,a.endTime,a.buffer,t.origin),ct(a)})).catch((a=>{e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin)})):e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin),B()?A(e,t,r,o):lt(e,t,r,o),Ne("Viewer loaded")}(t,i,r,n,o),_e({main_op:"getUserInfoFromAcrobat"},(e=>{q._sendMessage({type:"adobeYoloUserData",...e},N.origin)})),i.data.visitorID){const t=e.getItem("viewerVisitorID");e.setItem("viewerVisitorID",i.data.visitorID),t&&t!==i.data.visitorID&&ke("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}_e({main_op:"checkWhatsNewVersion"});break;case"getFileBufferRange":!function(e,t){let a={url:W};R.getFileBufferRange(a,e.data.range).then((a=>{X||(X=!0),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,a.buffer,e.origin)})).catch((a=>{ke("DCBrowserExt:Viewer:Error:Linearization:Range:Failed"),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,-1,e.origin)}))}(i,t);break;case"previewFailed":K||(ke("DCBrowserExt:Viewer:Error:FallbackToNative:Preview:Failed"),K=!0,Ue());break;case"lastUserGuid":e.setItem("lastUserGuid",i.data.value);break;case"signin":ke("DCBrowserExt:Viewer:Ims:Sign:In"),Fe();break;case"signout":ke("DCBrowserExt:Viewer:Ims:Sign:Out"),e.removeItem("viewer-locale"),e.removeItem("userDetailsFetchedTimeStamp"),e.removeItem("discoveryExpiryTime"),e.removeItem("viewer-locale"),rt(i.data.fileBuffer,Ae);break;case"googleAppsPrintShown":a.setItem("googleAppsPrint","false"),ke("DCBrowserExt:Viewer:GoogleApps:Print:Shown");break;case"signInExperimentShown":chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const a=t[0],n=(new Date).getTime();e.setItem("signInExperimentShown",JSON.stringify({currTabId:a.id,timestamp:n}))}));break;case"disableViewer":e.setItem("pdfViewer","false"),chrome.tabs.reload();break;case"signInExperimentClosed":case"signInExperimentSkipped":e.setItem("signInExperimentSuppressed","true");break;case"enableBeta":e.setItem("betaOptOut","false"),chrome.tabs.reload();break;case"disableBeta":e.setItem("betaOptOut","true"),chrome.tabs.reload();break;case"updateTitle":mt(i.data.title);break;case"viewer_set_item":gt.setItem(i.data.key,i.data.value,i.data.startup);break;case"viewer_remove_item":gt.removeItem(i.data.key,i.data.startup);break;case"storage_sync_to_async_cleanup":_e({main_op:"storage-migration-sync-to-async-cleanup"});break;case"adminStatus":e.setItem("isAdminUser",i.data.isAdmin)}}}catch(e){ke("DCBrowserExt:Viewer:Error:MessageHandler:Unknown")}}}function ut(){if(!G)return ke("DCBrowserExt:Viewer:Error:Handshake:TimedOut"),Ue(),!1}const pt=t=>{try{e.getItem("enableCSRF")&&We();const n=ne.getHeaderValue("content-length");l=n;const r=ne.getHeaderValue("accept-ranges"),o=r&&"bytes"===r.toLowerCase();W=t.originalUrl,Je();const i=new URLSearchParams(new URL(W).search).get("blob-uri");h(i,W)?$="Acrobat Tutorial.pdf":$||($=function(){let e;const t=ne.getHeaderValue("content-disposition");if(t&&/\.pdf(["']|$)/i.test(t)){const a=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(t);null!=a&&a.length>1&&(e=a[1].replace(/['"]/g,""))}return e||(e=Ye(W)),decodeURIComponent(e)}());const s={url:W},c=new URL(e.getItem("cdnUrl"));N||(N=c);let d=null;const m="false"!==ye("linearization")&&!a.getItem("bufferTabId");m&&o&&n>0&&(d=R.getFileBufferRange(s,{start:0,end:1024})),window.addEventListener("message",ft(q,t,d)),_t(),setTimeout(ut,25e3)}catch(e){Ne("InitMimeHandlerScript failed",e),Ue()}},ht=e=>I(e).has(V)||ye(V)?.length>0,wt=e=>{const t=I(e),a=E("outlook_chrome","native_view");return t.get(V)===a||ye(V)===a},It=e=>"https://drive.usercontent.google.com"===e?.origin&&e?.searchParams?.has(V),bt=e=>chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:e}),vt=()=>{try{if(W&&ht(W)&&!a.getItem("acrobatPromotionWorkflow")){const t=Se(new URL(W)?.search,V)||ye(V),a=je(t),n="true"===e.getItem(`${a}-pdf-default-viewership`);Promise.all([bt(`dc-cv-${a}-default-viewership`),bt(`dc-cv-${a}-default-viewership-control`)]).then((([e,r])=>{!function(e,t){const a={main_op:"analytics"};a.analytics=[[e]],t&&a.analytics[0].push(t),_e(a)}(`DCBrowserExt:Viewer:ExtnViewerPdfOpened:${t}`,U(n,e,a,e||r))}))}}catch(e){}};function yt(){if(a.getItem("signInAction")){const e=a.getItem("signInAction");q._sendMessage({type:"signInInformation",action:e,source:"signIn"===e?a.getItem("signInSource"):a.getItem("signUpSource")},N.origin),a.removeItem("signInSource"),a.removeItem("signUpSource"),a.removeItem("signInAction")}}async function _t(){chrome.storage.onChanged.addListener(((t,a)=>{"local"===a&&Object.entries(t).forEach((([t,{newValue:a}])=>{switch(t){case"theme":q._sendMessage({type:"themeChange",theme:a},N.origin);break;case"ANALYTICS_OPT_IN_ADMIN":{const t="false"!==e.getItem("logAnalytics"),n="false"!==a;q._sendMessage({type:"analyticsTrackingChange",value:t&&n},N.origin);break}case"saveLocation":q._sendMessage({type:"changeSaveLocationPreference",saveLocation:a},N.origin);break;case"isDarkPageThemeEnabled":q._sendMessage({type:"darkPageThemeChange",isDarkPageThemeEnabled:a},N.origin);break;case"egaf":q._sendMessage({type:"enableGenAIFeaturesToggled",enableGenAIFeatures:a},N.origin);break;case"akamai":_e({main_op:"reRegisterUninstallUrl"})}}))})),await async function(){return O=await o.isInstalledViaUpsell(),O}(),q._sendMessage({type:"setAsyncStorage",storage:e.getItem("viewerStorageAsync")},N.origin),_e({main_op:"viewer-startup",url:W,startup_time:Date.now(),viewer:!0},(e=>{Ve.isSharePointURL=!!e.isSharePointURL,Ve.isSharePointFeatureEnabled=!!e.isSharePointEnabled,Ve.isFrictionlessEnabled=!!e.isFrictionlessEnabled,Ve.featureFlags=e.featureFlags,Ve.isFillAndSignRegisteryEnabled=e.isFillnSignEnabled;const t=De().href;q.sendStartupConfigs(t,N.origin)})),_e({main_op:"get-features&groups",cachePurge:"LAZY"},(e=>{q._sendMessage({type:"featureGroups",featureGroups:e.featureGroups,featureFlags:e.featureFlags,ffResponse:e.ffResponse},N.origin)})),Z?setTimeout((()=>qe("loadedTabsInfo",Q)),2e3):_e({main_op:"updateLoadedTabsInfo"}),ge||"preview"===a.getItem("acrobatPromotionWorkflow")||oe.writeAndSyncWithHistory(W,{filename:$,lastVisited:Date.now()})}function St(){q._sendMessage({type:"fgFlagsResponse",ffResponse:e.getItem("ffResponse_anon")||"{}",anonUserUUID:e.getItem("anonUserUUID")},N.origin)}function Lt(e){_e({main_op:"caret_mode_toggle_handler",toggleCaretModeValue:e})}function Rt(t,a,n){switch(t.panel_op&&!0===t.reload_in_native&&(delete t.is_viewer,chrome.tabs.reload(t.tabId)),t.content_op){case"showLocalFileAccessToast":t.tabId&&t.tabId!==e.getItem("lastOpenTabId")||q._sendMessage({type:"showLocalFileAccessToast"},N.origin);break;case"rapidRenditionResponse":q._sendMessage({type:"rapidRenditionResponse",pageRendition:t.pageRendition,perfMarker:t.perfMarker},N.origin);break;case"rapidRenditionError":q._sendMessage({type:"rapidRenditionError",error:t.error},N.origin)}switch(t.main_op){case"relay_to_content":if("dismiss"===t.content_op){delete t.content_op,delete t.reload_in_native;let e=document.getElementById("__acrobatDialog__");return void(e&&(e.remove(),e=null))}"caret_mode_toggle_handler"===t.content_op&&q._sendMessage({type:"toggleCaretMode",toggleCaretModeValue:t.status},N.origin);break;case"reset":q._sendMessage({type:"toggleAnalytics",logAnalytics:t.analytics_on},N.origin);break;case"showUninstallPopUp":q._sendMessage({type:"showUninstallPopUp"},N.origin);break;case"jumpUrlSuccess":(!Z||t.tabInfo&&t.tabInfo.includes(Q))&&q._sendMessage({type:"adobeYoloJumpUrlSuccess"},N.origin);break;case"triggerBufferSave":q._sendMessage({type:"triggerBufferSave"},N.origin);break;case"downloadFileSuccess":q._sendMessage({type:"downloadFileSuccess"},N.origin);break;case"openViewerAIAssistant":q._sendMessage({type:"openViewerAIAssistant"},N.origin);break;case"isGenAIEligibleInCDN":if(t.activeTabId==ie)return be.then(n),!0}return!1}function Ut(){const t=e.getItem("userState");let a=!1;if(void 0!==t?.rvu&&(a=!0),!0!==t.rvu){const t={rvu:a};e.setItem("userState",t)}}document.addEventListener("DOMContentLoaded",function(e){const t=(new Date).getTime();let a=window.setInterval((function(){(function(){const e=document.getElementById("dc-view-frame");return e&&e.contentWindow&&1===e.contentWindow.length}()||(new Date).getTime()-t>15e3)&&(window.clearInterval(a),e.call(this))}),200)}((function(){const e=document.getElementById("dc-view-frame");e&&e.contentWindow&&e.contentWindow.focus()}))),window.onerror=e=>{g.error({message:"Viewer errored out",error:e})},window.addEventListener("unhandledrejection",(e=>{e.reason?.toString?.()?.includes("the message channel closed before a response was received")||g.error({message:"Viewer unhandled promise rejection",reason:e.reason?.toString?.(),stack:e.reason?.stack})})),void 0!==chrome.runtime&&(oe=new _,o.isMimeHandlerAvailable().then((async function(t){if(chrome.runtime.onMessage.addListener(Rt),t){if(Z=!0,!window.navigator.onLine&&e.getItem("offlineSupportDisable"))return void Ue();e.getItem("sessionStarted")||(e.setItem("sessionId",n.uuid()),e.setItem("sessionStarted",!0));let t=await o.getStreamInfo()||{};if(ne=new v(t.responseHeaders),Q=t.tabId,0===Object.keys(t).length){const e=new URLSearchParams(window.location.search),a=e.get("pdfurl"),n=new URL(a);if(n.protocol===he){$=e.get("pdffilename");if(await m.hasKey(`chrome-extension://${chrome.runtime.id}/${n.href}`)){const e=await m.getFileByHash(`chrome-extension://${chrome.runtime.id}/${n.href}`);k(),ge=!0,H=!0,ne=new v({"content-type":"application/pdf","content-length":e.byteLength}),t={mimeType:"application/pdf",originalUrl:`chrome-extension://${chrome.runtime.id}/${n.href}`,responseHeaders:ne},Q=(await chrome.tabs.getCurrent())?.id}}}let a=await _e({main_op:"check-is-google-print"});ee=a&&a.isGooglePrint,ae=await o.caretModeStatus(),o.addCaretModeListener(Lt),_e({main_op:"viewer-preview",startup_time:Date.now(),viewer:!0},(()=>pt(t)));const r=ne.getHeaderValue("content-length"),i=ne.getHeaderValue("accept-ranges"),s=i&&"bytes"===i.toLowerCase();r>0&&s&&_e({main_op:"setupWorkerOffscreen",pdfURL:t.originalUrl,pdfSize:+r,acceptRanges:s});e.getItem("firstOpenedTabId")||e.setItem("firstOpenedTabId",Q)}else!function(){const e=new URL(window.location.href);if(e?.searchParams?.has("pdfurl")){const t=e.searchParams.get("pdfurl"),a=new URL(t);if(a?.searchParams.has("uuid")&&sessionStorage.getItem(a?.searchParams?.get("uuid"))){e.searchParams.set("pdfurl",sessionStorage.getItem(a?.searchParams?.get("uuid")));const t=Se(document.location.search,"pdffilename");history.replaceState({},t,e)}}}(),await Le(),(async()=>{try{if(e.getItem("enableCSRF")&&We(),!1===le)return void(H=!1);Je();const t=ye("clen")||-1,n=ye("chunk")||!1,r="false"!==ye("linearization")&&!a.getItem("bufferTabId"),o={url:W},i=(new Date).getTime(),s=new URL(e.getItem("cdnUrl")),c=new URLSearchParams(new URL(W).search).get("blob-uri");h(c,W)?$="Acrobat Tutorial.pdf":($=ye("pdffilename"),$=$?encodeURIComponent($):Ye(W)),document.title=decodeURIComponent($),N||(N=s);let l=null;const d=r&&n&&t>0;d&&(l=R.getFileBufferRange(o,{start:0,end:1024}));const m=(await chrome.tabs.getCurrent())?.id,g=Qe(m),f=(await g).buffer?g:at(q,d,s.origin);window.addEventListener("message",ft(q,f,l,i)),setTimeout(ut,25e3),vt()}catch(e){Ne("InitScript failed",e),Ue()}})(),_t()})))}();