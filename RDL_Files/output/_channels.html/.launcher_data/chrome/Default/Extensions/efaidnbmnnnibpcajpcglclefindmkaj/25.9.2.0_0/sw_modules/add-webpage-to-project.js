/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{dcLocalStorage as t}from"../common/local-storage.js";import{loggingApi as a}from"../common/loggingApi.js";import{sendCoiEnabledEvent as r}from"../common/util.js";import{checkForImsSidCookie as o}from"./api-util.js";import{common as n}from"./common.js";import s from"./ExplicitBlocklist.js";import{floodgate as c}from"./floodgate.js";import{createPerfTracker as i,PERF_MARKERS as m}from"./perf-tracker.js";import{cleanupUsedOrExpiredRequests as d,registerRequestId as l}from"./request-validator.js";import{util as u}from"./util.js";let g=!1;const p=new Map,f=function(){const e="abcdefghijklmnopqrstuvwxyz0123456789.-",t={};for(let a=0;a<38;a++)t[e[a]]="tubg6lxdq8jc1m9-vw.pfhskar0oi5zn372ye4"[a];return t}(),h=["documentcloud.adobe.com","acrobat.adobe.com","stage.acrobat.adobe.com","dev.acrobat.adobe.com"];async function b(e,t,r){try{const{collectionUrl:o,requestId:n,activeTab:s=!0}=e.data||{},c=new URL(o);chrome.tabs.query({url:`${c.origin}${c.pathname}*`,windowId:t?.tab?.windowId},(t=>{let c=!1;t?.length>0?chrome.tabs.update(t[0].id,{active:s,url:o}):(c=!0,chrome.tabs.create({url:o,active:s})),r({success:!0,closeDialog:e.data.closeDialog}),a.info({message:"AddWebpageToProject Open project url "+(c?"in new tab":"in existing tab"),requestId:n})}));await async function(e){try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:async()=>"function"==typeof window.extractWebpageHTML});return t?.[0]?.result}catch(e){return!1}}(t?.tab?.id)||await chrome.scripting.executeScript({target:{tabId:t?.tab?.id},files:["content_scripts/extract-webpage-html.js"]}),chrome.scripting.executeScript({target:{tabId:t?.tab?.id},func:async()=>await(window.extractWebpageHTML?.())})}catch(t){a.error({message:"Error in opening collection tab",error:t?.message,...e.data})}}async function _({url:e,domain:t}){if(!e&&!t)return!1;try{if(t||(t=new URL(e).hostname),h.includes(t))return!0;const[a=[],r=[]]=await Promise.all([s.getKWBlockList(),s.getExplicitBlocklist()]);return!![...a,...r].includes(function(e){return e.toLowerCase().split("").map((e=>f[e]||e)).join("")}(t))}catch(e){return a.error({message:"Error in checking for blocked domain",error:e?.message}),!1}}function w(){!function(){const e=Date.now();p.forEach(((t,a)=>{e-(t?.getStartTime?.()||0)>36e5&&p.delete(a)}))}(),d()}async function E(){await t.init();if(!await c.hasFlag("dc-cv-add-webpage-to-project"))return!1;const e="false"!==t.getItem("egaf"),r="true"===t.getItem("DISABLE_GENAI_BY_ADMIN"),o=t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),n=function(){const e=["en-US","en-GB"],r="true"===t.getItem("adobeInternal"),o="dc-cv-add-webpage-to-project";let n={};try{const t=JSON.parse(c.getFeatureMeta(o)||"{}");r&&(n=JSON.parse(c.getFeatureMeta(`${o}-internal`)||"{}"));const a=[...t.allowedLocales??[],...n.allowedLocales??[]];return a.length>0?a:e}catch(t){return a.error({message:"Failed to get AddWebpageToProject allowed locales:",error:t?.message}),e}}().includes(o)||o.startsWith("en");return!(!e||r||!n)}async function I(){const e=await E();try{e?g||(chrome.contextMenus.update("addWebpageToProject",{visible:!0}),g=!0):g&&(chrome.contextMenus.update("addWebpageToProject",{visible:!1}),g=!1)}catch(e){a.error({message:"Error creating AddWebpageToProject context menu",error:e?.message})}}function P(e){if(document.getElementById("addWebpageToProjectExtnIframe"))return;const{env:t,tabId:a,locale:r,requestId:o,context:n,imsca:s}=e,c=(e,t={})=>{const a={main_op:"kw-perf-mark",data:{requestId:o,name:e,metadata:t,timestamp:Date.now()}};chrome.runtime.sendMessage(a)};c("AWPP_Extension_Iframe_Creation_Started");const i=window?.matchMedia?.("(prefers-color-scheme: dark)"),m=i?.matches,d=document.createElement("iframe"),l=chrome.runtime.getURL("resources/addWebpage/index.html"),u=new URL(l);u.searchParams.set("env",t),u.searchParams.set("tabId",a),u.searchParams.set("locale",r),u.searchParams.set("requestId",o),u.searchParams.set("context",n),u.searchParams.set("theme",m?"dark":"light"),u.searchParams.set("imsca",s),d.src=u.toString(),d.id="addWebpageToProjectExtnIframe",d.allowFullscreen=!0,d.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border: none;\n        z-index: 10000;\n        background: rgba(0, 0, 0, 0.1);\n        color-scheme: light;\n    ",d.onload=()=>{c("AWPP_Extension_Iframe_Loaded")},d.onerror=()=>{c("AWPP_Extension_Iframe_Error"),f()},document.body.appendChild(d),c("AWPP_Extension_Iframe_Added_To_Document");const g=new URL(chrome.runtime.getURL("resources/addWebpage/index.html")).origin,p=e=>{if(e.origin!==g)return;const{main_op:t}=e.data;switch(t){case"closeAllIframes":f();break;case"openCollectionTab":chrome.runtime.sendMessage({main_op:"openCollectionTab",data:e.data},(e=>{e.closeDialog&&f()}));break;case"kw-perf-mark":const{main_op:t,...a}=e.data;chrome.runtime.sendMessage({main_op:t,data:a})}};i?.addEventListener?.("change",(e=>{c("AWPP_Extension_Iframe_Theme_Changed",{theme:e.matches?"dark":"light"})}));const f=()=>{const e=document.getElementById("addWebpageToProjectExtnIframe");e&&(c("AWPP_Extension_Iframe_Removed"),chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:o}}),window.removeEventListener("message",p),e.style.display="none",setTimeout((()=>{document.body.removeChild(e)}),2e3))};window.addEventListener("message",p),window.addEventListener("beforeunload",(()=>{chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:o}})}))}async function T(s,c,d){w();const u=new URL(c.url);r(c.id,{domain:u.hostname,expressTouchpoint:d});const g=`req_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;l(g,d);const f=i({requestId:g});p.set(g,f),f.mark(m.AWPP_CONTEXT_MENU_CLICKED),e.event(e.e.CONTEXT_MENU_ADD_WEB_PAGE_TO_PROJECT,{CONTEXT:d});const h=n.getEnv(),b=t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),_=await o(),E={env:h,locale:b,requestId:g,tabId:c.id,context:d,imsca:_};try{const e=await Promise.race([chrome.scripting.executeScript({target:{tabId:c.id},func:P,args:[E]}),new Promise(((e,t)=>{setTimeout((()=>{t(new Error("AddWebpageToProject Extension iframe script execution timeout"))}),1e4)}))]);if(!e||0===e.length)throw new Error("Script execution returned no results")}catch(e){let t=e?.message;chrome.runtime.lastError&&(t=chrome.runtime.lastError.message),f.mark(m.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_FAILED,{error:t}),a.error({message:"Error in executing AddWebpageToProject Extension iframe script",error:t,requestId:g})}finally{f.mark(m.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_COMPLETED)}}function x(e){T(0,{id:e.tabId,url:e.url},e.context)}chrome.runtime.onMessage.addListener(((e,t,r)=>{const o=e?.main_op;switch(o){case"openCollectionTab":b(e,t,r);break;case"kw-perf-mark":!function(e){const t=e?.data?.requestId,a=p.get(t);a&&a.mark(e.data.name,e.data.metadata)}(e);break;case"emit-perf-data":!function(e){const t=e?.data?.requestId,r=p.get(t);if(r){const e=r.getPerfTimings();a.info({message:"AddWebpageToProject_PerfTimings",perfTimings:e}),p.delete(t)}}(e)}return!0}));export{E as isAddWebpageToProjectEnabled,I as toggleAddWebpageToProjectContextMenu,T as handleAddWebpageToProjectContextMenu,x as handleAddWebpageToProjectAction,_ as checkForBlockedDomain};