/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{util as e}from"./util.js";import{common as t}from"./common.js";import{analytics as a}from"../common/analytics.js";import{Proxy as s}from"./proxy.js";import{floodgate as i}from"./floodgate.js";import{authProvider as r}from"./auth-provider.js";import{sharepointModule as o}from"./sharepoint-module.js";import{privateApi as n}from"./private-api.js";import{gmailConvertToPdfInit as l}from"./gmail-convert-to-pdf-module.js";import{viewerModuleUtils as c}from"./viewer-module-utils.js";import{SETTINGS as d}from"./settings.js";import{dcLocalStorage as p,dcSessionStorage as u}from"../common/local-storage.js";import{OFFSCREEN_DOCUMENT_PATH as m}from"../common/constant.js";import{CACHE_PURGE_SCHEME as g}from"./constant.js";import{closeExpress as h,getModalSessionId as b,isExpressContextMenuEnabled as f,isGmailNativeViewerExpressMenuEnabled as v,isGoogleImagePreviewExpressMenuEnabled as I,isWhatsappHoverExpressMenuEnabled as w,isWhatsappPreviewExpressMenuEnabled as E,isGmailMessageViewExpressMenuEnabled as T,launchExpress as F,removeSessionFromUnloadedExpressSessions as _,toggleExpressTouchpoints as S,isGdriveNativeViewerExpressMenuEnabled as P,isFacebookPreviewExpressMenuEnabled as D}from"./express.js";import{loggingApi as x}from"../common/loggingApi.js";import{resetDVSessionCount as C,getDVSessionCountString as R,fetchDefaultViewershipConfig as L}from"../content_scripts/gsuite/util.js";import{sendPingEventHandler as k}from"../common/util.js";import{checkForBlockedDomain as M,handleAddWebpageToProjectAction as A,isAddWebpageToProjectEnabled as y,toggleAddWebpageToProjectContextMenu as N}from"./add-webpage-to-project.js";import{getActiveExperimentAnalyticsArray as O,setExperimentCodeForAnalytics as V,removeExperimentCodeForAnalytics as U}from"../common/experimentUtils.js";import{tempURLBufferIndexedDB as G}from"../common/temporaryURLBufferIndexDB.js";import{linkedinInit as B}from"./linkedin-module.js";import{checkForImsSidCookie as W}from"./api-util.js";let H=null,j={},J={};class ${constructor(){this.tabs={},this.version=-1,this.NMHConnStatus=!0,this.activeTab=void 0,this.isAllowedLocalFileAccess=!1}proxy(...e){return s.proxy.bind(this)(...e)}LOG(...e){return t.LOG(...e)}setIsAllowedLocalFileAccess(e){this.isAllowedLocalFileAccess=e,p.setItem("isAllowedLocalFileAccess",e)}registerHandlers(t){J=e.extend(J,t)}registerModule(e,t){j[e]=t}getModule(e){return j[e]}getTabLastMessage(e){return this.tabs[e]}updateTabMessage(t,a){this.tabs[t]?this.tabs[t]=e.extend(this.tabs[t],a):this.tabs[t]=a}setNMHConnectionStatus(e){this.NMHConnStatus=e}legacyShim(){return this.version<=1}setVersion(e){this.version=e}resetPersistPrefCount(){p.setItem("persist-menu-closed",0)}incrementPersistPrefCount(e){let t=p.getItem("persist-menu-closed");t<10&&"false"!==p.getItem("always-show-pdf-menu")&&(t++,p.setItem("persist-menu-closed",t)),t>=10&&(p.setItem("always-show-pdf-menu","false"),e||a.event(a.e.PERSIST_PDF_OPENPDF_PREF_OFF))}diffDays(e,t){const a=Math.abs(e-t);return Math.floor(a/864e5)}enableReprompt(){if(!p.getItem("repromptCount")||parseInt(p.getItem("repromptCount"))<d.REPROMPT_DORMANT_USER_ATTEMPTS){let e=Date.now(),t=p.getItem("fteDenied")&&10===parseInt(p.getItem("fteDenied")),a=p.getItem("pdfViewer"),s=d.VIEWER_ENABLED,i=!p.getItem("reprompt-user-timestamp"),r=p.getItem("repromptCount")?p.getItem("repromptCount"):0,o=p.getItem("reprompt-user-timestamp")&&this.diffDays(e,p.getItem("reprompt-user-timestamp"))>=d.REPROMPT_DORMANT_USER_TIME_INTERVALS[r];return s&&!a&&t&&(o||i)}return!1}async isEnablePersistMenu(e){if(e&&"mime-native"===e.viewer&&(d.IS_ERP_READER||d.IS_READER)&&p.getItem("openInAcrobatEnable")&&"admin"!==p.getItem("installSource"))return!1;if(await n.isInstalledViaUpsell()&&!p.getItem("pdfViewer"))return!1;if(e&&"mime"===e.viewer)return!1;if(d.VIEWER_ENABLED&&(d.IS_ACROBAT&&!d.VIEWER_ENABLED_FOR_ACROBAT||p.getItem("fteDenied")||"true"!==p.getItem("pdfViewer")||this.resetPersistPrefCount()),d.REPROMPT_DORMANT_USER&&this.enableReprompt()){let e=p.getItem("repromptCount")?parseInt(p.getItem("repromptCount"))+1:1;p.setItem("repromptCount",e),p.setItem("fteDenied",9),p.setItem("persist-menu-closed",9),p.removeItem("always-show-pdf-menu")}return"false"!==p.getItem("always-show-pdf-menu")&&(p.getItem("persist-menu-closed")<10?!(this.legacyShim()&&(!d.VIEWER_ENABLED||p.getItem("pdfViewer"))):"true"===p.getItem("always-show-pdf-menu")&&(this.resetPersistPrefCount(),!0))}isViewerEnabled(){return!(!d.VIEWER_ENABLED||d.IS_ACROBAT&&!d.VIEWER_ENABLED_FOR_ACROBAT||"true"!==p.getItem("pdfViewer"))}async relayMessageToContentScript(e,t,a){if(1==e.newUI&&"dismiss"===e.content_op)e.persist=!1,null!=e.tabId&&(this.tabs[e.tabId].persist=!1),this.incrementPersistPrefCount(e.fteClosed);else if(1==e.newUI&&"pdf_menu"===e.panel_op){await this.isEnablePersistMenu(e)?null!=e.tabId&&(this.tabs[e.tabId].persist=!0):e.persist=!1,this.resetPersistPrefCount()}this.sendMessage(e,t,a)}isViewerEnabledOrFromExternalTouchPoint(e){return this.isViewerEnabled()||c.isPDFURLFromExternalTouchPoint(e)}sendViewerStartupInformation(t,s,r){if(this.isViewerEnabledOrFromExternalTouchPoint(s)&&e.isViewerURL(s)||t.mimeHandled){if("viewer-startup"===t.main_op&&(delete t.main_op,t.isFrictionlessEnabled=d.FRICTIONLESS_ENABLED,t.isSharePointEnabled=o.isFeatureEnabled(),t.isSharePointURL=!1),t.isSharePointEnabled)try{let e=new URL(s).searchParams.get("pdfurl");t.isSharePointURL=o.isAllowListedSharePointURL(e)}catch(e){}t.mimeHandled&&(a.event(a.e.VIEWER_EXTN_PDF_OPENED,{tabURL:s}),s.startsWith("file://")?a.event(a.e.VIEWER_PDF_LOCAL_FILE):a.event(a.e.VIEWER_PDF_OPENED_MIME_HANDLER)),t.isFillnSignEnabled=d.FILL_N_SIGN_ENABLED,i.getFeaturesAndGroups().then((({featureFlags:e})=>{t.featureFlags=e,r(t)})).catch((a=>{r(t),e.consoleLog(a)}))}}async sendViewerPreviewInformation(e,t){this.sendMessage({dend_op:"viewer-type",viewer:"mime",tabId:e.tabId,is_pdf:!0}),await c.updateVariables(this.version),t()}handlerTabs(e){e&&e.tabId&&"outermost_frame"===e.frameType&&communicate.filterLoadedTabs(e)}async filterLoadedTabs(e){const t=await n.isMimeHandlerAvailable(),a=p.getItem("loadedTabsInfo");if(a&&a.tabsInfo){const s=a.tabsInfo||[];if(t){if(s.includes(e.tabId)){const t=s.filter((t=>t!==e.tabId));t.length>0?p.setItem("loadedTabsInfo",{tabsInfo:t}):p.removeItem("loadedTabsInfo")}}else{-1!==s.findIndex((t=>t.id==e.tabId))&&this.getCurrentTabInfoAndUpdateLoadedTabs()}}}async getCurrentTabInfoAndUpdateLoadedTabs(){const e=await n.isMimeHandlerAvailable(),t=p.getItem("loadedTabsInfo"),a=t?.tabsInfo;if(!e&&a){const e=`chrome-extension://${chrome.runtime.id}/*`;let t=await chrome.tabs.query({url:e});t=t.filter((e=>e.url!==chrome.runtime.getURL("browser/js/local-fte.html"))),t.length?p.setItem("loadedTabsInfo",{tabsInfo:t}):p.removeItem("loadedTabsInfo")}}handler(s,o,d){var u,f=this;if(!s)return;if(this.dump(s,"Communicate Handler receive: "),s.mimeHandled){var v={id:s.tabId,url:s.url};o.tab=v}const I=`chrome-extension://${chrome.runtime.id}/browser/js/popup.html`,w=`chrome-extension://${chrome.runtime.id}/${m}`,E=`chrome-extension://${chrome.runtime.id}/resources/SidePanel/index.html`,T=o.url?.split("?")[0]||o.tab?.url;if([I,w,E].includes(T)&&(o.tab=s.tab,delete s.tab),o&&o.tab&&(s.tabId=o.tab.id,this.activeTab||(this.activeTab=o.tab.id),s.main_op)){switch(u=s.main_op,delete s.main_op,a.logBrowserAnalytics(s),this.tabs[s.tabId]&&this.tabs[s.tabId].suppress_frictionless&&(s.suppress_frictionless=this.tabs[s.tabId].suppress_frictionless),s.version=this.version,s.NMHConnStatus=this.NMHConnStatus,u){case"embedded-pdf-touch-point-added":chrome.tabs.sendMessage(s.tabId,{type:"added-embedded-pdf-touch-point",frameId:s?.frameId,position:s?.position}),chrome.tabs.sendMessage(s.tabId,{action:"reRenderShowOneChild"});break;case"reRenderShowOneChild":chrome.tabs.sendMessage(s.tabId,{action:"reRenderShowOneChild"});break;case"hideAIMarkerPopup":chrome.tabs.sendMessage(s.tabId,{content_op:"hideAIMarkerPopup",href:s.href});break;case"updateIframeHeight":chrome.tabs.sendMessage(s.tabId,{content_op:"updateIframeHeight",href:s.href,menuOpen:s.menuOpen});break;case"logOverlappingElements":chrome.tabs.sendMessage(s.tabId,{content_op:"logOverlappingElements",elementRect:s.elementRect,link:s.link});break;case"outlook-touch-point-added":chrome.tabs.sendMessage(s.tabId,{action:"reRenderShowOneChild"});break;case"linkedin-touch-point-added":chrome.tabs.sendMessage(s.tabId,{type:"added-linkedin-pdf-touch-point",frameId:s?.frameId,position:s?.position}),chrome.tabs.sendMessage(s.tabId,{action:"reRenderShowOneChild"});break;case"log-error":x.error(s.log);break;case"log-info":x.info(s.log);break;case"embedded-pdf-touch-point-fte":chrome.tabs.sendMessage(s.tabId,{type:"add-fte-for-embedded-pdf-touch-point"},{frameId:s.frameId});break;case"outlook-fte-render":chrome.tabs.sendMessage(s.tabId,{type:"add-fte-for-outlook-touch-point"});break;case"linkedin-fte-render":chrome.tabs.sendMessage(s.tabId,{type:"add-fte-for-linkedin-touch-point",frameId:s.frameId});break;case"changeDefaultViewershipForSurface":this.handleChangeDefaultViewershipForSurface(s);break;case"acrobat-gmail-fte-config":case"acrobat-gmail-convert-to-pdf-verb-fte-config":this.gmailFteConfigUpdated(s);break;case"reRenderShowOneChild":chrome.tabs.sendMessage(s.tabId,{action:"reRenderShowOneChild"});break;case"get-express-modal-session-id":d({sessionId:b(s.tabId)});break;case"express-init":this.expressInit(d);break;case"whatsapp-express-init":this.whatsappExpressInit(d);break;case"gmail-express-init":this.gmailExpressInit(d);break;case"google-image-preview-express-init":this.googleImagePreviewExpressInit(d);break;case"gdrive-express-init":this.gdriveExpressInit(d);break;case"facebook-express-init":this.facebookExpressInit(d);break;case"gmail-init":this.gmailInit(d);break;case"gmail-convert-to-pdf-init":l(d);break;case"acrobat-gdrive-fte-state":this.gdriveFteStateUpdated(s);break;case"gdrive-init":this.gdriveInit(d,s.tabId);break;case"outlook-init":this.outlookInit(d);break;case"linkedin-init":B(this.version,o).then(d);break;case"embedded-pdf-touch-point-config":this.embeddedPDFTouchPointConfig(s,d,o);break;case"gdrive-download-init":this.gDriveDownloadPageInit(d);break;case"viewer-preview":return this.sendViewerPreviewInformation(s,d),!0;case"get-features&groups":return i.getFeaturesAndGroups(s.cachePurge).then((e=>d(e))),!0;case"getFloodgateFlag":i.hasFlag(s.flag,s.cachePurge).then(d);break;case"getFloodgateMeta":d(i.getFeatureMeta(s.flag));break;case"isUserSignedIn":r.isUserSignedIn().then(d);const m=p.getItem("imsConsciousTabs")||[];m.includes(s.tabId)||(m.push(s.tabId),p.setItem("imsConsciousTabs",m));break;case"openRecentFileLink":let v=s.recent_file_url;new URLSearchParams(s.recent_file_url)?.has("acrobatPromotionSource")&&(v=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(s.recent_file_url)+"&pdffilename="+encodeURIComponent(s.file_name)),e.createTab(v);break;case"openOnboardingTutorialFile":let I=new URL(s.onboardingDemoFileURL);I.searchParams.set("blob-uri",s.blobParam),I.searchParams.set("returnURL",s.pdfURL),I.searchParams.set("returnTabId",s.tabId),I=I.toString(),e.createTab(I);break;case"returnToYourFile":const w=`chrome-extension://${chrome.runtime.id}/*`;chrome.tabs.query({url:w},(t=>{let a=t?.find((e=>e.id==s.returnTabId));a?chrome.tabs.update(a.id,{active:!0}):e.createTab(s.returnURL)}));break;case"openLocalFileThoughFilePicker":e.createTab("").then((({id:e})=>{const t=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(s.fileURL)+"&pdffilename="+encodeURIComponent(s.file_name)+(s.openGenAIAssistantPanel?"&ogap="+s.openGenAIAssistantPanel:"")+"&tabId="+e+(s.openLocalFileSource?"&olfs="+s.openLocalFileSource:"");chrome.tabs.update(e,{url:t})}));break;case"viewer-type":setTimeout((()=>{this.sendMessage({dend_op:"viewer-type",viewer:s.viewer,tabId:s.tabId,is_pdf:!0})}),500);case"init-floodgate":setTimeout((()=>{i.init(),i.getFeaturesAndGroups()}),2e3);break;case"complete_conversion":e.createTab(s.conversion_url);break;case"analytics":break;case"pdf-contentType-event":i.hasFlag("dc-cv-content-type-pdf-analtyics",g.NO_CALL).then((e=>{"true"===p.getItem("pdfViewer")&&e&&a.event(a.e.PDF_CONTENT_TYPE_EVENT)}));break;case"relay_to_content":this.relayMessageToContentScript(s,s.shouldCache??!0,d);break;case"viewer-startup":s.main_op="viewer-startup",this.sendViewerStartupInformation(s,o.tab.url,d);break;case"check-cookie":d(p.getItem(s.key));break;case"set-cookie":p.setItem(s.key,s.value);break;case"check-mime-viewer-availability":n.isMimeHandlerAvailable().then((e=>{e?"false"===p.getItem("pdfViewer")||"true"===p.getItem("cdnFailure")?this.sendMessage({dend_op:"viewer-type",tabId:o.tab.id,viewer:"mime-native",is_pdf:!0}):s.url&&s.url.startsWith("file://")&&(this.isAllowedLocalFileAccess||(a.event(a.e.VIEWER_PDF_LOCAL_FILE_IGNORED),f.sendMessage({dend_op:"viewer-type",tabId:o.tab.id,viewer:"mime-native",is_pdf:!0}))):this.sendMessage({dend_op:"viewer-type",tabId:o.tab.id,viewer:"native",is_pdf:!0})}));break;case"uninstall":n.setViewerState("disabled"),p.setItem("pdfViewer","false"),p.setItem("always-show-pdf-menu","false"),e.mimeReloadAllTabs(),p.removeItem("userEligibleForUninstall"),chrome.runtime.setUninstallURL(""),a.event(a.e.UNINSTALL_DIALOG_UNINSTALLED_SUCCESSFUL),setTimeout((()=>{chrome.management.uninstallSelf()}),1e3);break;case"caret_mode_toggle_handler":chrome.runtime.sendMessage({main_op:"relay_to_content",content_op:"caret_mode_toggle_handler",status:s.toggleCaretModeValue});break;case"initialise-popup":this.initialisePopup(o.tab,d);break;case"addExperimentCodeForAnalytics":V(s.experimentCode);break;case"cancelWebpageConversion":case"clearStatus":this.cancelConversion(this.tabs[o.tab.id]);break;case"triggerBufferSave":chrome.runtime.sendMessage({main_op:"triggerBufferSave"});break;case"closeExpressApp":h(o.tab.id);break;case"toggle-express-touch-points":S(s.allowed);break;case"removeSessionFromUnloadedExpressSessions":_(o.tab.id,s.touchpoint,s.domain);break;case"handleViewerFloodgateResponse":i.handleViewerFloodgateResponse(s.fgResponse);break;case"launch-express":F({srcUrl:s.imgUrl,intent:s.intent,touchpoint:s.touchpoint},o.tab);break;case"local-storage-remove":p.removeItem(s?.key);break;case"getExperimentCodes":d(O());break;case"isAddWebpageToProjectEnabled":y().then((e=>d(e)));break;case"kw-is-blocked-domain":M({domain:s.domain}).then((e=>d(e)));break;case"add-webpage-to-project":A({...s,url:o?.tab?.url});break;case"toggle-add-webpage-to-project-context-menu":N();break;case"openPDFInNewTab":if(s.url?.match(/\.pdf(?=\?|#|$)/i)){const t=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(s.url);e.createTab(t)}break;case"get-welcome-pdf-url":const E=t.getWelcomePdfUrlHost(),T=e.getWelcomePDFUrl(E);d(T);break;case"initializeViewerVariables":c.initializeViewerVariables(this.version);break;case"check-ims-cookie":W().then((e=>d(e)));break;case"akamai-ping":k();break;default:return J[u]?(a.setOp({preview:"Copy",image_preview:"Image",send:"Send",fillsign:"FillSign",export:"Export",acom:"GotoAcom",to_pdf:"ConvertToPdf"}[s.handleResult]),J[u](s,o,d)):void e.consoleLog("failed to find handler for: "+u)}return!0}}gmailSelectors(){return Promise.resolve((()=>{const e=i.getFeatureMeta("dc-cv-gmail-selectors"),t=i.getFeatureMeta("dc-cv-gmail-selectors-list-view"),a=i.getFeatureMeta("dc-cv-gmail-selectors-native-viewer");let s={};try{s.messageView=JSON.parse(e),s.listView=JSON.parse(t),s.nativeViewer=JSON.parse(a)}catch(e){}return s})())}gmailFteToolTipConfig(){return Promise.resolve((()=>{let e=i.getFeatureMeta("dc-cv-gmail-fte-tooltip");try{e=JSON.parse(e)}catch(t){e={tooltip:{shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1}}}return e})())}initStorageForGSuiteFlows(e,t,a){p.setItem(`${e}-pdf-dv-feature-enablement-status`,t?.toString()),p.setItem(`${e}-pdf-dv-feature-control-enablement-status`,a?.toString())}fetchFeatureEnablementStatusForDefaultViewership(e){return i.hasFlag(`dc-cv-${e}-default-viewership`)}async gmailInit(t){const[a,s,r,o,n,l]=await Promise.all([this.gmailSelectors(),this.gmailFteToolTipConfig(),chrome.storage.local.get("acrobat-touch-points-in-other-surfaces"),L("gmail"),this.fetchFeatureEnablementStatusForDefaultViewership("gmail"),i.hasFlag("dc-cv-gmail-acrobat-touch-point")]);this.initStorageForGSuiteFlows("gmail",n,!1);try{await c.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for Gmail:",e)}t({touchPointSettingEnabled:this.touchPointSetting(r),selectors:a,acrobatPromptText:e.getTranslation("gsuiteOpenWithAcrobat"),gmailFteToolTipStrings:this.getSurfaceFTEToolTipStrings(n,"gmail"),fteConfig:s,isAcrobatDefaultForSurface:"true"===o,enableDefaultViewershipFeatureForGmail:n,isUserPartOfExperimentControlOrTreatmentForGmailDV:n,enableGmailTouchPoint:l})}touchPointSetting(e){return"false"!==e["acrobat-touch-points-in-other-surfaces"]}getSurfaceFTEToolTipStringsForGdriveNonDV(){return{title:e.getTranslation("acrobatGsuiteFteToolTipTitleNonDV"),description:e.getTranslation("acrobatGsuiteFteToolTipDescriptionNonDV",e.getTranslation("surfaceNameGdrive")),button:e.getTranslation("closeButton")}}getSurfaceFTEToolTipStrings(t,a){let s,i;return"gmail"===a?i=e.getTranslation("surfaceNameGmail"):"gdrive"===a&&(i=e.getTranslation("surfaceNameGdrive")),s=t&&!p.getItem(`${a}-pdf-default-viewership-user-disabled`)?{title:e.getTranslation("acrobatGsuiteFteToolTipTitleDV"),description:e.getTranslation("acrobatGsuiteFteToolTipDescriptionDV",i),button:e.getTranslation("closeButton")}:{title:e.getTranslation("acrobatGsuiteFteToolTipTitleNonDV"),description:e.getTranslation("acrobatGsuiteFteToolTipDescriptionNonDV",i),button:e.getTranslation("closeButton")},s}async embeddedPDFTouchPointConfig(t,a,s){const r=await i.hasFlag("dc-cv-embedded-pdf-touch-point"),o="false"===p.getItem("acrobat-touch-point-in-embedded-pdf"),n="en-US"===p.getItem("locale")||"en-GB"===p.getItem("locale");try{await c.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for embedded PDF:",e)}let l;try{l=JSON.parse(i.getFeatureMeta("dc-cv-embedded-pdf-touch-point"))}catch(e){l={tooltip:{shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1},blockedDomains:["outlook.office.com","attachments.office.net"]}}const d=r&&!o&&n;d?V("EMP"):U("EMP"),a({enableEmbeddedPDFTouchPoint:d,touchPointConfig:l,touchPointText:e.getTranslation("embeddedPDFOpenInAcrobatTooltip"),fteToolTipStrings:{title:e.getTranslation("embeddedPDFTouchPointFTEHeader"),description:e.getTranslation("embeddedPDFTouchPointFTEBody"),button:e.getTranslation("closeButton")},menuItemStrings:{hideIconForNow:e.getTranslation("embeddedPDFHideIconForNow"),openPDFInAcrobat:e.getTranslation("embeddedPDFOpenPDFInAcrobat"),managePreferences:e.getTranslation("embeddedPDFManagePreferences")},tabId:t?.tabId,frameId:s?.frameId,contextMenuTooltipText:e.getTranslation("preferences")})}async outlookInit(t){const[a,s]=await Promise.all([i.hasFlag("dc-cv-outlook-pdf-touch-point"),i.hasFlag("dc-cv-outlook-pdf-touch-point-control")]);try{await c.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for Outlook:",e)}let r,o,n;const l="false"===p.getItem("acrobat-touch-points-in-other-surfaces");try{const e=JSON.parse(i.getFeatureMeta("dc-cv-outlook-pdf-touch-point"));r=e?e.tooltip:{},o=e?e.selectors:{},n=!!e&&e.fteEnabled}catch(e){r={shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1}}a?(U("OTC"),V("OT")):s?(U("OT"),V("OTC")):(U("OT"),U("OTC")),t({enableOutlookPDFTouchPoint:a&&!l,selectors:o,fteConfig:r,touchPointString:e.getTranslation("gsuiteOpenWithAcrobat"),fteToolTipStrings:{title:e.getTranslation("outlookPDFTouchPointFTEHeader"),description:e.getTranslation("outlookPDFTouchPointFTEBody"),button:e.getTranslation("closeButton")},errorToastStrings:{title:e.getTranslation("outlookErrorToastTitle"),description:e.getTranslation("outlookErrorToastDescription")},enableOutlookFteTooltip:n})}async gdriveInit(t){const[a,s,r,o,n,l,d,u,m,g,h,b,f,v,I,w,E,T,F]=await Promise.all([i.hasFlag("dc-cv-gdrive-open-in-extension"),i.getFeatureMeta("dc-cv-gdrive-selectors"),i.hasFlag("dc-cv-gdrive-fte-tooltip"),i.getFeatureMeta("dc-cv-gdrive-fte-tooltip"),i.hasFlag("dc-cv-gdrive-grid-view-touchpoint"),i.getFeatureMeta("dc-cv-gdrive-grid-view-selectors"),i.hasFlag("dc-cv-gdrive-list-view-touchpoint"),i.getFeatureMeta("dc-cv-gdrive-list-view-selectors"),i.getFeatureMeta("dc-cv-gdrive-pdf-selectors"),i.hasFlag("dc-cv-gdrive-triple-dot-menu-analytics"),i.hasFlag("dc-cv-gdrive-list-grid-view-fte-tooltip"),chrome.storage.local.get("acrobat-touch-points-in-other-surfaces"),i.hasFlag("dc-cv-gdrive-grid-view-touchpoint-migration"),i.hasFlag("dc-cv-gdrive-list-view-touchpoint-migration"),i.hasFlag("dc-cv-gdrive-search-bar-analytics"),i.getFeatureMeta("dc-cv-gdrive-search-selectors"),L("gdrive"),this.fetchFeatureEnablementStatusForDefaultViewership("gdrive"),i.hasFlag("dc-cv-gdrive-default-viewership-control")]);try{await c.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for GDrive:",e)}let _,S,P,D,x,C,R;try{_=s?JSON.parse(s):{},S=o?JSON.parse(o):{},P=l?JSON.parse(l):{},D=u?JSON.parse(u):{},x=w?JSON.parse(w):{},R=m?JSON.parse(m):{},P.pdfSvgPath=R?.svg,D.pdfSvgPath=R?.svg,_.GoogleDriveListView=D,_.GoogleDriveGridView=P,_.GoogleDriveSearchBar=x,C=this.touchPointSetting(b)}catch(e){S={tooltip:{shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1}},C=!1}const k=n||f,M=d||v;n&&p.setItem("gvt","dc-cv-gdrive-grid-view-touchpoint"),d&&p.setItem("lvt","dc-cv-gdrive-list-view-touchpoint"),t({acrobatTouchPointEnabled:C,enableOpenInExtension:a,acrobatPromptText:e.getTranslation("gsuiteOpenWithAcrobat"),selectors:_,fteToolTipStrings:this.getSurfaceFTEToolTipStrings(T,"gdrive"),fteToolTipStringsForNativeViewNonDV:this.getSurfaceFTEToolTipStringsForGdriveNonDV(),enableGDriveGridViewTouchPoint:k,enableGDriveListViewTouchPoint:M,enableGDriveTripleDotMenuAnalytics:g,enableGDriveSearchBarAnalytics:I,fteConfig:S,enableFteToolTip:r,enableFteToolTipForListGridView:h,isAcrobatDefaultForSurface:"true"===E,enableDefaultViewershipFeatureForGoogleDrive:T,isUserPartOfExperimentControlOrTreatmentForGoogleDriveDV:F||T}),this.initStorageForGSuiteFlows("gdrive",T,F)}gdriveFteStateUpdated(e){chrome.tabs.query({url:["https://drive.google.com/*"]},(function(t){t?.forEach((function(t){t.id!==e.tabId&&chrome.tabs.sendMessage(t.id,{content_op:"acrobatGdriveFteStateUpdated",fteState:e?.fteState})}))}))}async gDriveDownloadPageInit(e){const[t,a]=await Promise.all([i.getFeatureMeta("dc-cv-gdrive-download-page-selectors"),chrome.storage.local.get("acrobat-touch-points-in-other-surfaces")]);let s,r;try{s=JSON.parse(t),r=this.touchPointSetting(a)}catch(e){r=!1}e({selectors:s,acrobatTouchPointEnabled:r})}gmailFteConfigUpdated(e){chrome.tabs.query({url:["https://mail.google.com/*"]},(function(t){t?.forEach((function(t){t?.id!==e.tabId&&chrome.tabs.sendMessage(t.id,{content_op:"acrobatGmailFteStateUpdated",fteState:e?.fteState})}))}))}async handleChangeDefaultViewershipForSurface(e){if(!await this.fetchFeatureEnablementStatusForDefaultViewership(e.surfaceId))return;const t={gmail:"https://mail.google.com/*",gdrive:"https://drive.google.com/*"},s=`${e.surfaceId}-pdf-default-viewership`;if(p.getItem(s)!==e.isDefault?.toString()){const i=s+"-user-disabled";e.isDefault?e.isDefault&&(p.removeItem(i),a.event(`DCBrowserExt:${e.surfaceId}:DefaultViewership:Enabled`,{eventContext:e.source}),C(e.surfaceId)):(p.setItem(i,"true"),R(e.surfaceId).then((t=>{a.event(`DCBrowserExt:${e.surfaceId}:DefaultViewership:Disabled`,{dvDisableSessionCount:t,eventContext:e.source})}))),p.setItem(s,e.isDefault?.toString()),chrome.tabs.query({url:t[e.surfaceId]},(function(t){t?.forEach((t=>{e.tabId===t.id&&e.syncToOtherTabsOnly||chrome.tabs.sendMessage(t.id,{content_op:"changeDefaultViewershipForSurface",isDefault:e.isDefault,surfaceId:e.surfaceId,source:e.source})}))}))}}async expressInit(t){const[a]=await Promise.all([f()]),s=a.enableExpressContextMenu,r=a.enableExpressOptionsPagePreference,o=a.enableExpressTooltip,n=i.getFeatureMeta("dc-cv-express-context-menu-tooltip");let l;try{l=JSON.parse(n)}catch(e){l={minimumImageDimension:{height:100,width:150},imageCount:5}}const c=i.getFeatureMeta("dc-cv-express-context-menu-tooltip-allow-list");let d={allowListArray:[]};if(c)try{d.allowListArray=JSON.parse(c)}catch(e){}t({enableExpressContextMenu:s,shouldEnableExpressTouchpointsPreference:r,showExpressTooltip:o,imageDimension:l.minimumImageDimension,imageCount:l.imageCount,allowInfo:d,expressTooltipStrings:{title:e.getTranslation("expressFteTitle"),description:e.getTranslation("expressFteDescription"),footer:e.getTranslation("expressFTEFooter"),popoverTitle:e.getTranslation("expressPopoverFTETitle"),popoverDescription:e.getTranslation("expressPopoverFTEDescription")}})}async whatsappExpressInit(t){const a=await E(),s=await w(),r=i.getFeatureMeta("dc-cv-express-whatsapp-preview"),o=i.getFeatureMeta("dc-cv-express-whatsapp-hover");let n,l;try{n=JSON.parse(r)}catch(e){n=null}try{l=JSON.parse(o)}catch(e){l=null}const c=await i.hasFlag("dc-cv-express-whatsapp-fte");t({enableWhatsappPreviewExpressMenu:a.enableWhatsappPreviewExpressMenu,enableWhatsappHoverExpressMenu:s.enableWhatsappHoverExpressMenu,enableWhatsappPreviewExpressFte:c,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference||s.enableExpressOptionsPagePreference,selectors:{...n?.selectorList,...l?.selectorList},fteStrings:{title:e.getTranslation("expressContextualFteTitle","WhatsApp"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async gmailExpressInit(t){const a=await v(),s=await T(),r=i.getFeatureMeta("dc-cv-express-gmail-native-viewer"),o=i.getFeatureMeta("dc-cv-express-gmail-message-view"),n=await i.hasFlag("dc-cv-express-gmail-nv-single-cta"),l=await i.hasFlag("dc-cv-express-gmail-fte");let c,d;try{c=JSON.parse(r)}catch(e){c=null}try{d=JSON.parse(o)}catch(e){d=null}t({...a,...s,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference||s.enableExpressOptionsPagePreference,selectors:{...c?.selectorList,...d?.selectorList},singleCTAEnabled:n,enableGmailExpressFte:l,fteStrings:{title:e.getTranslation("expressContextualFteTitle","Gmail"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async googleImagePreviewExpressInit(t){const a=await I(),s=i.getFeatureMeta("dc-cv-express-google-image-preview"),r=await i.hasFlag("dc-cv-express-google-image-preview-single-cta"),o=await i.hasFlag("dc-cv-express-google-image-preview-fte");let n;try{n=JSON.parse(s)}catch(e){n=null}t({...a,selectors:n?.selectorList,singleCTAEnabled:r,enableGoogleImagePreviewExpressFte:o,fteStrings:{title:e.getTranslation("expressContextualFteTitle","Google Images"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async gdriveExpressInit(t){const a=await P(),s=i.getFeatureMeta("dc-cv-express-gdrive-native-viewer"),r=await i.hasFlag("dc-cv-express-gdrive-native-viewer-fte");let o;try{o=JSON.parse(s)}catch(e){o=null}t({...a,selectors:{...o?.selectors},enableGdriveExpressFte:r,fteStrings:{title:e.getTranslation("expressContextualFteTitle","Google Drive"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async facebookExpressInit(e){const t=await D(),a=i.getFeatureMeta("dc-cv-express-facebook-preview");let s;try{s=JSON.parse(a)}catch(e){s=null}e({...t,selectors:s?.selectors})}async initialisePopup(a,s){let i={hostedURL:t.getPopupCDNUrl()};if(this.tabs[a.id]){i=e.extend(i,this.tabs[a.id]);const t=`chrome-extension://${chrome.runtime.id}`;a.url.startsWith(t)&&(i.is_extension_url=!0);["chrome://extensions/",t,"chrome://newtab/","https://chrome.google.com","https://acrobat.adobe.com/link/file/?uri=","https://acrobat.adobe.com/id/urn:","https://acrobat.adobe.com/link/review/?uri="].some((e=>a.url.startsWith(e)))&&(i.isBlacklistedUrl=!0);if(!["downloading","pdf_downloading","waiting","in_progress","complete"].includes(i.current_status)||i.isBlacklistedUrl){const e=i.is_pdf;this.clearStatus(i),i.is_pdf=e}e.isLocalFileUrl(a.url)&&(i.is_pdf=!0,i.isFillnSignEnabled=d.FILL_N_SIGN_ENABLED),i.isAcrobat=e.isAcrobatAvailable(this.version),i.autoOpenPDFInAcrobat="false"!==p.getItem("ViewResultsPref")}s(i)}echoRequest(t){var a,s,i;if(!(d.CHROME_VERSION<d.SUPPORTED_VERSION)){if(!this.avoidUrl(t.url)){var r=t.id||t.tabId;return this.tabs[r]&&("cancelled"!==(a=this.tabs[r]).current_status&&"pdf_opened"!==a.current_status&&"pdf_failure"!==a.current_status&&"viewer_menu"!==a.panel_op||(i=a.is_pdf,this.clearStatus(a),a.is_pdf=i),a.current_status&&(a.panel_op="status"),s=a.is_pdf?"pdf_menu":"html_menu",a.panel_op&&"load-frictionless"===a.panel_op&&delete a.panel_op,"resize_window"===a.content_op&&(delete a.content_op,delete a.window_height),a.panel_op=a.panel_op||s,"html_menu"===s&&(a.persist=!1),a.incognito=t.incognito,e.isLocalFileUrl(t.url)&&(a.panel_op="pdf_menu",a.is_pdf=!0,a.isFillnSignEnabled=d.FILL_N_SIGN_ENABLED),t.url.startsWith(`chrome-extension://${chrome.runtime.id}`)?(a.panel_op="viewer_menu",a.is_viewer=!0):a.is_viewer=!1,e.consoleLog("repeat cached request: "+a.panel_op)),a}this.disable(t.id)}}setGlobals(e){this.globals=e}dump(t,a){var s,i=[a];for(s in t)t.hasOwnProperty(s)&&i.push("  "+s+": "+t[s]);e.consoleLog(i.join("\n"))}sendMessage(t,s=!0,i){var r,o=t.tabId;this.dump(t,"Sending message:"),t.version=this.version,e.consoleLog("sendMessage version",t),s&&(this.tabs[o]=e.extend(this.tabs[o],t)),t.NMHConnStatus=this.NMHConnStatus,t.show_frictionless=!0,t.is_edge=e.isEdge(),"flickr"===t.panel_op&&(r=a.e.FLICKR_OFFER_SHOWN),r&&a.checkAndLogAnalytics(r),e.sendMessage(t,this.globals,i),delete t.mimeHandled,delete this.tabs[o].mimeHandled}deferMessage(e){"undefined"==typeof setTimeout?this.sendMessage(e):setTimeout(this.proxy(this.sendMessage,e),0)}sendMessageToPopup(t,a=!0){const s=t.tabId;t.version=this.version,a&&(this.tabs[s]=e.extend(this.tabs[s],t)),t.NMHConnStatus=this.NMHConnStatus,t.is_edge=e.isEdge(),chrome.runtime.sendMessage(t)}filenameFromUrl(e){try{const t=decodeURIComponent(e),a=t.split("?")[0].split("/").filter((e=>e.length>0)),s=a.length>0?a[a.length-1]:"untitled";let i=s;const r=s.length-4;return(s.length<4||s.toLowerCase().indexOf(".pdf")!==r)&&(i+=".pdf"),i}catch(e){return"untitled.pdf"}}async pdf_menu(t,s){var i;if(delete(i=this.tabs[s.tab.id]=e.extend(this.tabs[s.tab.id],{tabId:s.tab.id})).dend_op,i.filename=this.filenameFromUrl(t.url),i.panel_op="pdf_menu",i.url=t.url,i.viewer=t.viewer,i.incognito=s.tab.incognito,i.fteFeatureFlag=t.fteFeatureFlag,i.isFillnSignEnabled=d.FILL_N_SIGN_ENABLED,i.isSharePointEnabled=o.isFeatureEnabled(),1==i.isSharePointEnabled&&(i.isSharePointURL=o.isAllowListedSharePointURL(i.url)),1==t.persist){const e=await this.isEnablePersistMenu(t);i.persist=!!e}else i.persist=!1;const r=p.getItem("fteDenied");var n=!(0==t.version||1==t.version||t.version===d.READER_VER||t.version===d.ERP_READER_VER);const l=d.VIEWER_ENABLED&&!p.getItem("pdfViewer")&&(!r||10!==parseInt(r))&&(!n||d.VIEWER_ENABLED_FOR_ACROBAT);if("false"!==p.getItem("always-show-pdf-menu")&&"mime"!==i.viewer&&(1!=i.persist||l||(delete i.fteFeatureFlag,a.event(a.e.PERSIST_PDF_MENU_SHOWN)),this.deferMessage(i)),l){let e,s=p.getItem("repromptCount");switch(t.fteFeatureFlag){case"dc-cv-fte-pdf-redcard":e=a.e.PERSIST_PDF_MENU_RED_CARD_FTE_SHOWN;break;case"dc-cv-fte-pdf-dmb":e=a.e.PERSIST_PDF_MENU_DMB_FTE_SHOWN;break;default:e=a.e.PERSIST_PDF_MENU_FTE_SHOWN}s?a.event(e,{LAUNCH:"Reprompt"}):a.event(e,{LAUNCH:"Launch"})}if(!i.incognito)if("true"!==p.getItem("pdfViewer")||"native"!==i.viewer&&"mime-native"!==i.viewer){if(!p.getItem("pdfViewer")||"false"===p.getItem("pdfViewer")){let e="Acrobat";this.legacyShim()?e="NoApp":this.version!==d.READER_VER&&this.version!==d.ERP_READER_VER||(e="Reader"),"native"!==i.viewer&&"mime-native"!==i.viewer||a.event(a.e.VIEWER_DISABLED_PDF_OPEN_NATIVE_VIEWER,{APPLICATION:e})}}else a.event(a.e.VIEWER_ENABLED_PDF_OPEN_NATIVE_VIEWER)}loaded(t){this.tabs[t]=e.extend(this.tabs[t],{tabId:t,loaded:!0})}setIsPDF(t,a){this.tabs[t]=e.extend(this.tabs[t],{tabId:t,is_pdf:a})}cancelConversion(e){this.getModule("acro-web2pdf").cancelConversion(e.tabId),delete e.current_status,delete e.file_path,delete e.domtitle,delete e.timing,delete e.panel_op,delete e.is_pdf,delete e.newUI}clearStatus(e,t){"in_progress"!==e.current_status&&"downloading"!==e.current_status&&(t||"waiting"!==e.current_status)&&this.cancelConversion(e)}loading(t){var a=t.id;this.tabs[a]=e.extend(this.tabs[a],{tabId:a,loaded:!1}),this.clearStatus(this.tabs[a],!0)}async active(t){this.activeTab=t.tabId,this.tabs[this.activeTab]=e.extend(this.tabs[this.activeTab],{tabId:t.tabId});if(await this.isEnablePersistMenu()){var a=this.echoRequest(this.tabs[this.activeTab]);a&&a.persist&&this.sendMessage(a)}}disable(e){this.tabs[e]&&(this.tabs[e].loaded=!1)}close(e){this.getModule("acro-web2pdf").cancelConversion(e),delete this.tabs[e],this.activeTab===e&&(this.activeTab=null),G.cleanTemporaryURLBufferEntry(e)}tabReplace(e,t){this.close(t),this.loaded(e)}activeTab(){return this.activeTab}noop(){}avoidUrl(t){if(t=t||"",d.VIEWER_ENABLED&&p.getItem("pdfViewer")&&e.isViewerURL(t))return!1;if(this.version===d.ERP_READER_VER)return!0;if(t.startsWith("https://chrome.google.com"))return!0;if(this.version==d.READER_VER&&0==d.FRICTIONLESS_ENABLED)return!t.endsWith(".pdf")&&!t.endsWith(".PDF");if((0==this.version||1==this.version&&0==this.NMHConnStatus)&&!1===d.FRICTIONLESS_ENABLED)return!1;p.getItem("appLocale");const a=this.isAllowedLocalFileAccess&&e.isLocalFileUrl(t);return!t.startsWith("http")&&!a}}H||(H=new $,H.registerHandlers({"send-analytics":H.proxy(H.noop)}));export const communicate=H;