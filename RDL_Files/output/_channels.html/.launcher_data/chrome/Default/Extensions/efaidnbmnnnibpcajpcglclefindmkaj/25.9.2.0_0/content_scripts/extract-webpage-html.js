/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
const extractWebpageHTML=async()=>(window.extractionPromise||(window.extractionPromise=new Promise((e=>{const t=()=>{const t=performance.now(),r=window.location.href,o=document.cloneNode(!0),a=["data:","blob:","chrome-extension:","javascript:","mailto:","tel:","file:","ftp:","about:","chrome:","edge:"],s=()=>{const e=Array.from(o.querySelectorAll("img[src]")),t=Array.from(o.querySelectorAll('*[style*="background-image"]')),a=Array.from(o.querySelectorAll(["*[data-bgsrc]","*[data-bg]","*[data-background]","*[data-background-src]","*[data-bg-src]","*[data-lazy-bg]","*[data-lazy-background]"].join(", "))),s=e.map(((e,t)=>e.src.startsWith("data:")?Promise.resolve():fetch(e.src,{mode:"cors"}).then((e=>e.blob())).then((t=>new Promise((r=>{const o=new FileReader;o.onload=()=>{e.src=o.result,e.hasAttribute("srcset")&&e.removeAttribute("srcset"),r()},o.onerror=()=>{e.hasAttribute("srcset")&&e.removeAttribute("srcset"),r()},o.readAsDataURL(t)})))).catch((()=>{e.hasAttribute("srcset")&&e.removeAttribute("srcset")})))),n=t.map((e=>{const t=e.getAttribute("style"),r=t.match(/background-image:\s*url\(['"]?([^'"()]+)['"]?\)/);return r&&!r[1].startsWith("data:")?fetch(r[1],{mode:"cors"}).then((e=>e.blob())).then((o=>new Promise((a=>{const s=new FileReader;s.onload=()=>{const o=t.replace(r[0],`background-image: url(${s.result})`);e.setAttribute("style",o),a()},s.onerror=()=>a(),s.readAsDataURL(o)})))).catch((()=>{})):Promise.resolve()})),c=a.map((e=>{const t=["data-bgsrc","data-bg","data-background","data-background-src","data-bg-src","data-lazy-bg","data-lazy-background"];let o=null,a=null;for(const r of t){const t=e.getAttribute(r);if(t&&t.trim()){o=t.trim(),a=r;break}}if(o&&!o.startsWith("data:"))try{const t=new URL(o,r).href;return fetch(t,{mode:"cors"}).then((e=>e.blob())).then((t=>new Promise((r=>{const s=new FileReader;s.onload=()=>{const t=e.getAttribute("style")||"",o=t+(t&&!t.endsWith(";")?"; ":"")+`background-image: url(${s.result});`;e.setAttribute("style",o),e.removeAttribute(a),r()},s.onerror=()=>{console.warn(`Failed to process data background image: ${o}`),r()},s.readAsDataURL(t)})))).catch((e=>(console.warn(`Failed to fetch data background image: ${o}`,e),Promise.resolve())))}catch(e){return console.warn(`Invalid data background URL: ${o}`,e),Promise.resolve()}return Promise.resolve()}));return Promise.race([Promise.allSettled([...s,...n,...c]),new Promise((e=>setTimeout(e,15e3)))]).then((()=>{}))},n=async e=>{const t=e.head,r=window.location.href,o=[],a=Array.from(t.querySelectorAll("link"));for(const e of a){const t=e.getAttribute("rel"),a=e.getAttribute("href");switch(t){case"stylesheet":break;case"icon":case"shortcut icon":case"apple-touch-icon":if(a&&!a.startsWith("data:"))try{const t=new URL(a,r).href;o.push({element:e,url:t,attribute:"href",type:"favicon"})}catch(t){console.warn("Invalid favicon URL:",a),e.remove()}else a||e.remove();break;case"canonical":if(a)try{const t=new URL(a,r).href;e.setAttribute("href",t)}catch(t){console.warn("Invalid canonical URL:",a),e.remove()}break;case"preload":case"prefetch":case"preconnect":case"dns-prefetch":case"modulepreload":case"manifest":e.remove();break;case"alternate":if(a)try{const t=new URL(a,r).href;e.setAttribute("href",t)}catch(t){console.warn("Invalid alternate URL:",a),e.remove()}break;default:if(a&&!a.startsWith("data:")&&!a.startsWith("#"))try{const t=new URL(a,r).href;e.setAttribute("href",t)}catch(e){console.warn("Invalid link URL:",a)}}}const s=Array.from(t.querySelectorAll("meta"));for(const e of s){const t=e.getAttribute("property"),a=e.getAttribute("name"),s=e.getAttribute("content");if(s)if(t&&(t.includes("og:image")||t.includes("twitter:image"))||a&&(a.includes("twitter:image")||a.includes("msapplication-TileImage"))){if(!s.startsWith("data:"))try{const t=new URL(s,r).href;o.push({element:e,url:t,attribute:"content",type:"meta-image"})}catch(t){console.warn("Invalid meta image URL:",s),e.remove()}}else if(t&&(t.includes("og:url")||t.includes("twitter:url"))||a&&a.includes("twitter:url"))try{const t=new URL(s,r).href;e.setAttribute("content",t)}catch(e){console.warn("Invalid meta URL:",s)}else"refresh"===e.getAttribute("http-equiv")&&e.remove()}if(Array.from(t.querySelectorAll("script")).forEach((e=>{(e.getAttribute("src")||e.textContent)&&e.remove()})),o.length>0){const e=o.map((async e=>{try{const t=await fetch(e.url,{mode:"cors",headers:{Accept:"image/*,*/*;q=0.8"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const r=await t.blob(),o=await new Promise(((e,t)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=t,o.readAsDataURL(r)}));e.element.setAttribute(e.attribute,o)}catch(t){console.warn(`Failed to embed ${e.type}:`,e.url,t),e.element.remove()}}));await Promise.race([Promise.allSettled(e),new Promise((e=>setTimeout(e,15e3)))])}if(!t.querySelector("base")){const o=e.createElement("base");o.setAttribute("href",r),t.insertBefore(o,t.firstChild)}return e};o.querySelectorAll("a[href], link[href]").forEach((e=>{const t=e.getAttribute("href");if(t&&!t.startsWith("javascript:")&&!t.startsWith("mailto:")&&!t.startsWith("tel:"))try{const o=new URL(t,r).href;e.setAttribute("href",o)}catch(e){console.warn("Invalid href URL:",t)}})),o.querySelectorAll("[src]").forEach((e=>{const t=e.getAttribute("src");if(t&&!a.some((e=>t.startsWith(e))))try{const o=new URL(t,r).href;e.setAttribute("src",o)}catch(e){console.warn("Invalid src URL:",t)}})),o.querySelectorAll("img[srcset]").forEach((e=>{const t=e.getAttribute("srcset");if(t)try{const o=t.split(",").map((e=>{const t=e.trim().split(/\s+/),o=t[0],s=t[1]||"";if(!a.some((e=>o.startsWith(e)))){const e=new URL(o,r).href;return s?`${e} ${s}`:e}return e.trim()}));e.setAttribute("srcset",o.join(", "))}catch(e){console.warn("Invalid srcset:",t)}})),o.querySelectorAll("form[action]").forEach((e=>{const t=e.getAttribute("action");if(t&&!t.startsWith("javascript:"))try{const o=new URL(t,r).href;e.setAttribute("action",o)}catch(e){console.warn("Invalid action URL:",t)}})),Promise.all([(()=>{let e="";try{const t=Array.from(document.styleSheets).map(((e,t)=>new Promise((r=>{try{if(e.cssRules){let t="";Array.from(e.cssRules).forEach((e=>{t+=e.cssText+"\n"})),r(t)}else r(e.href?`/* External stylesheet: ${e.href} */\n`:"")}catch(o){console.warn(`Cannot access stylesheet ${t}:`,o),r(e.href?`/* External stylesheet: ${e.href} */\n`:"")}}))));return document.querySelectorAll("style").forEach(((t,r)=>{t.textContent&&(e+=`/* Inline Style Block ${r+1} */\n`,e+=t.textContent+"\n")})),Promise.all(t).then((t=>(e=t.join("")+e,e)))}catch(t){return console.warn("Error capturing CSS rules:",t),Promise.resolve(e)}})(),(Array.from(document.querySelectorAll("*")),void Array.from(o.querySelectorAll("*")))]).then((([e])=>Promise.all([s(),n(o)]).then((([,t])=>(e=>{const t=new Set,r=new Map;if([/(-webkit-mask-image|mask-image):\s*url\(['"]?([^'"()]+)['"]?\)/gi,/background-image:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/border-image(-source)?:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/list-style-image:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/@font-face[^}]*src:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/cursor:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/filter:\s*url\(['"]?([^'"()]+)['"]?\)/gi].forEach((r=>{let o;const a=new RegExp(r.source,r.flags);for(;null!==(o=a.exec(e));){let e;if(o[2]?e=o[2]:o[1]&&(e=o[1]),e&&!e.startsWith("data:")&&!e.startsWith("#"))try{const r=new URL(e,window.location.href).href;t.add(r)}catch(t){console.warn("Invalid CSS URL:",e)}}})),0===t.size)return Promise.resolve(e);const o=Array.from(t).map((e=>fetch(e,{mode:"cors",headers:{Accept:"image/*,*/*;q=0.8"}}).then((e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.blob()})).then((t=>new Promise(((o,a)=>{const s=new FileReader;s.onload=()=>{r.set(e,s.result),o()},s.onerror=()=>{console.warn(`Failed to convert CSS resource to data URL: ${e}`),a()},s.readAsDataURL(t)})))).catch((t=>(console.warn(`Failed to fetch CSS resource: ${e}`,t),Promise.resolve())))));return Promise.race([Promise.allSettled(o),new Promise((e=>setTimeout(e,2e4)))]).then((()=>{let t=e;return r.forEach(((e,r)=>{const o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(o,"g");t=t.replace(a,e)})),t}))})(e))))).then((r=>{const a=o.getElementById("html-extraction-progress");a&&a.remove();const s=o.getElementById("addWebpageToProjectExtnIframe");s&&s.remove(),o.querySelectorAll('link[rel="stylesheet"]').forEach((e=>e.remove())),o.querySelectorAll("script").forEach((e=>e.remove()));const n=o.createElement("style");if(n.textContent=`\n/* Original CSS with all media queries intact and embedded resources */\n${r}\n\n/* Screen-specific computed styles (won't affect print) */\n@media screen {\n${window.extractedElementStyles||""}\n}\n`,!o.querySelector("meta[charset]")){const e=o.createElement("meta");e.setAttribute("charset","UTF-8"),o.head.insertBefore(e,o.head.firstChild)}o.head.appendChild(n),delete window.extractedElementStyles;const c=performance.now()-t,l=new Blob([o.documentElement.outerHTML],{type:"text/html"}),i=URL.createObjectURL(l),m=document.createElement("a");m.href=i,m.download="webpage.html",e({html:o.documentElement.outerHTML,title:document.title,url:window.location.href,processingTime:c,timestamp:Date.now()})})).catch((t=>{e({html:o.documentElement.outerHTML,title:document.title,url:window.location.href,error:t.message,partial:!0})}))};if("complete"===document.readyState)setTimeout(t,500);else{let e;const r=setTimeout((()=>{window.removeEventListener("load",e),t()}),3e4);e=()=>{t(),clearTimeout(r)},window.addEventListener("load",e)}}))),window.extractionPromise);window.extractWebpageHTML=extractWebpageHTML;