/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
const isGoogleSearchLink=checkGoogleSearchLink(),isDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches;let hoverTimeout,showAssistantMarker=!0,isCursorOnPopup=null,hoveredLink=null,currentPopupTimeouts=new Map;function showPopup(e,t,n=!1){if(isInvalidContentScript())return;const o=`__assistantPopup__${t}`;if(document.getElementById(o))n||(hoverTimeout=setTimeout((()=>showPopup(e,t,!0)),300));else{let n=e.getBoundingClientRect(),i=document.createElement("iframe");i.id=o,i.style.cssText=`\n            border: 0;\n            z-index: 127;\n            position: absolute;\n            margin: auto;\n            background: transparent;\n            color-scheme: auto;\n            left: ${n.right+(scrollX||0)}px;\n            top: ${n.top+(scrollY||0)-8}px;\n            width: 200px;\n            height: 50px;\n            min-height: unset;\n            overflow: hidden;\n        `,i.src=chrome.runtime.getURL("browser/js/assistantPopup.html?pdfMarkerLink="+t+"&theme="+(isDarkMode?"dark":"light")),document.body.appendChild(i),i.addEventListener("mouseenter",(()=>{isCursorOnPopup=t})),i.addEventListener("mouseleave",(()=>{isCursorOnPopup=null,setTimeout((()=>hidePopup(t)),400)}))}}function hidePopup(e,t=!1){if(!t&&(hoveredLink===e||isCursorOnPopup===e))return;const n=`__assistantPopup__${e}`,o=document.getElementById(n);if(o){currentPopupTimeouts.has(e)&&clearTimeout(currentPopupTimeouts.get(e)),o.contentWindow.postMessage({action:"exit"},`chrome-extension://${chrome.runtime.id}`);const t=setTimeout((()=>{o.remove(),currentPopupTimeouts.delete(e)}),400);currentPopupTimeouts.set(e,t)}}function checkGoogleSearchLink(){const e=window.location.href;return/https:\/\/www\.google\.(com|[a-z]{2}|com\.[a-z]{2}|co\.[a-z]{2}|cat)\/search\?/.test(e)&&e.includes("q=")}function isPDFLink(e,t){return e&&e.match(/\.pdf(?=\?|#|$)/i)&&t.trim().length>0}let pdfLinksCache=null;function getPDFLinks(){if(null===pdfLinksCache){const e=Array.from(document.querySelectorAll("a[href]"));pdfLinksCache=e.filter((e=>isPDFLink(e.getAttribute("href"),e.textContent)))}return pdfLinksCache}function addPdfIconToLinks(){getPDFLinks().forEach((e=>{const t=e.getAttribute("href"),n=isGoogleSearchLink?e.getElementsByTagName("h3")[0]:e;n&&(e.addEventListener("mouseenter",(()=>{showAssistantMarker&&(hoveredLink=t,hoverTimeout=setTimeout((()=>{showPopup(n,t),chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-genai-markers-impression-analytics",cachePurge:"NO_CALL"},(e=>{e&&chrome.runtime.sendMessage({main_op:"analytics",analytics:[["DCBrowserExt:PdfLink:Hovered"]]})}))}),200),n.style.backgroundColor="rgb(88, 76, 204, 0.1)",n.style.borderRadius="8px")})),e.addEventListener("mouseleave",(()=>{n.style.backgroundColor="",n.style.borderRadius="",setTimeout((()=>hidePopup(t)),400),hoveredLink=null,clearTimeout(hoverTimeout)})))}))}function logOverlappingElements(e,t){if(!e||t!==hoveredLink)return;const n=document.getElementById("__assistantPopup__"+t),o=n?.getBoundingClientRect();if(!n)return;const i={top:o.top+e.top,left:o.left+e.left,bottom:o.top+e.bottom,right:o.left+e.right,width:e.width,height:e.height,x:o.left+e.x,y:o.top+e.y};getClickableOverlappingElement(n,i).length>0&&chrome.runtime.sendMessage({main_op:"log-info",log:{message:"AI marker popup is overlapped by another element",link:t}})}!async function(){const e=getPDFLinks().length>0;chrome.runtime.sendMessage({main_op:"resolve-has-pdf-promise",hasPDFLink:e});const t=await chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-genai-markers",cachePurge:"NO_CALL"});if(!e||!t)return;const{appLocale:n,pdfViewer:o,egaf:i,aiMarkers:r,genAIEligible:s,locale:a}=await chrome.storage.local.get(["appLocale","pdfViewer","egaf","aiMarkers","genAIEligible","locale"]);if("en"!==n?.split("-")[0]||"en"!==a?.split("-")[0]||"false"===o||"false"===i||"false"===r||"true"!==s)return;const l="true"===(await chrome.storage.managed.get("DisableGenAI"))?.DisableGenAI,c=await chrome.runtime.sendMessage({main_op:"getFloodgateMeta",flag:"dc-cv-genai-markers-allowlist"});let u;try{u=JSON.parse(c||"[]").some((e=>window.location.href.match(e)))}catch(e){u=!1}!l&&u&&(chrome.runtime.sendMessage({main_op:"addExperimentCodeForAnalytics",experimentCode:"EGMS"}),addPdfIconToLinks())}(),chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.content_op){case"hideAIMarkerPopup":hidePopup(e.href,!0),showAssistantMarker=!1;break;case"updateIframeHeight":const t=`__assistantPopup__${e.href}`,n=document.getElementById(t);n&&(n.style.height=(e.menuOpen?125:50)+"px",n.style.width=(e.menuOpen?350:200)+"px");break;case"logOverlappingElements":logOverlappingElements(e.elementRect,e.link)}}));