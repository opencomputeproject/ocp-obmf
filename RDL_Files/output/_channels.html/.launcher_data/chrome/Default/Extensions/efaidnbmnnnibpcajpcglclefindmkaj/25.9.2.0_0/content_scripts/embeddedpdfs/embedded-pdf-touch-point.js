/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
const sendAnalytics=(e,t)=>{try{t={...t,domain:domain},chrome.runtime.sendMessage({main_op:"analytics",analytics:[[e,t]]})}catch(e){}};let domain="";if(window.self!==window.top){const e={},t="acrobat-embedded-pdf-touch-point",n="acrobat-embedded-pdf-touch-point-context-menu",o="acrobat-embedded-pdf-touch-point-drag-handle",d="acrobat-embedded-pdf-touch-point-drag-handle-visible";let a;const s=20;let c=!1,i=0,r=null;const m=async()=>{a=await import(chrome.runtime.getURL("content_scripts/gsuite/util.js"))},l=(e,t={})=>{const n={...t,domain:domain};a?.sendAnalyticsOncePerMonth(e,n)},u=e=>{const t=document.createElement("div");return t.classList.add("acrobat-embedded-pdf-touch-point-tooltip"),t.innerText=e?.touchPointText||"Open in Acrobat",t},p=e=>{const t=document.createElement("div");return t.classList.add("acrobat-embedded-pdf-touch-point-tooltip"),t.innerText=e?.contextMenuTooltipText||"Preferences",t},h=()=>{const e=document.createElement("img");return e.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_trefoil_24_white.svg")),e.classList.add("acrobat-embedded-pdf-icon"),e},b=()=>{const e=document.createElement("img");return e.setAttribute("src",chrome.runtime.getURL("browser/images/SDC_ShowMenu_18_N_24Canvas.svg")),e.classList.add("acrobat-embedded-pdf-touch-point-context-menu-icon"),e},g=()=>{document.getElementsByClassName("acrobat-fte-tooltip-container")?.length>0&&document.getElementsByClassName("acrobat-fte-tooltip-container")[0]?.remove()},E=()=>{const e=document.createElement("div");return e.classList.add("acrobat-embedded-pdf-drag-shield"),e},f=(e,t)=>{if("Enter"===e.key||" "===e.key||"click"===e.type){sendAnalytics("DCBrowserExt:EmbeddedPDF:TouchPoint:Clicked"),chrome.storage.local.set({embeddedPDFTouchPointFTEState:{touchPointClicked:!0}});const e=new URL(t);e.searchParams.set("acrobatPromotionSource","embeddedPDF");const n=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(e.toString());window.open(n),g()}},C=e=>{e.classList.remove("has-open-menu");const t=document.getElementsByClassName(n)?.length>0&&document.getElementsByClassName(n)[0];t&&(sendAnalytics("DCBrowserExt:EmbeddedPDF:Menu:Closed"),t.remove()),T()},w=(e,t)=>{const n=document.createElement("div");return n.textContent=e,n.classList.add("acrobat-embedded-pdf-touch-point-context-menu-item"),n.addEventListener("click",(e=>{e.stopPropagation(),t(e)})),n},y=(e,n)=>w(e?.menuItemStrings?.hideIconForNow,(()=>{document.getElementsByClassName(t)?.length>0&&document.getElementsByClassName(t)[0].remove(),sendAnalytics("DCBrowserExt:EmbeddedPDF:HideNow:Clicked"),C(n)})),v=()=>{const e=document.createElement("hr");return e.classList.add("acrobat-embedded-pdf-touch-point-context-menu-item-separator"),e},D=(e,t)=>w(e?.menuItemStrings?.openPDFInAcrobat,(e=>{f(e,window.location.href),sendAnalytics("DCBrowserExt:EmbeddedPDF:OpenInAcrobat:Clicked"),C(t)})),P=(e,t)=>w(e?.menuItemStrings?.managePreferences,(async()=>{sendAnalytics("DCBrowserExt:EmbeddedPDF:ManagePreferences:Clicked"),await chrome.storage.local.set({optionsPageSource:"EMBEDDED_PDF_TOUCH_POINT"}),chrome.runtime.sendMessage({type:"open_options_page",highlightSection:["embedded-pdf-touchpoint-section"]}),C(t)})),L=(e,t)=>{const n=document.createElement("div");n.classList.add(o);const d=document.createElement("img");return d.setAttribute("src",chrome.runtime.getURL("browser/images/S_DragHandle_18_N.svg")),n.appendChild(d),n.addEventListener("mousedown",(o=>R(o,n,e,t))),n},B=e=>e.getBoundingClientRect().top<188?"bottom":"top",F=e=>{const t=document.createElement("div");t.classList.add(n);return"bottom"===B(e)&&(t.style.bottom="auto",t.style.top="34px"),t},x=e=>{const t=document.createElement("div");t.classList.add("acrobat-embedded-pdf-menu-click-shield"),t.setAttribute("aria-hidden","true"),k(t,e);const n=e;n?.firstChild?n.insertBefore(t,n.firstChild):n.appendChild(t)},T=()=>{document.getElementsByClassName("acrobat-embedded-pdf-menu-click-shield")?.length>0&&document.getElementsByClassName("acrobat-embedded-pdf-menu-click-shield")[0]?.remove()},k=(e,t)=>{e.addEventListener("click",(e=>{e.preventDefault(),C(t)}))},A=(e,t,o,d)=>{if(e.getElementsByClassName(n)&&e.getElementsByClassName(n)[0])t.style.removeProperty("background"),C(d);else{sendAnalytics("DCBrowserExt:EmbeddedPDF:Menu:Clicked");const t=F(d),n=D(o,d),a=y(o,d),s=P(o,d),c=v();t.appendChild(n),t.appendChild(c),t.appendChild(a),t.appendChild(s),e.appendChild(t),d.classList.add("has-open-menu"),T(),x(d)}},N=e=>{const t=document.createElement("div");t.classList.add("acrobat-embedded-pdf-icon-container");const n=h();t.appendChild(n);const o=u(e);return t.appendChild(o),t.addEventListener("click",(e=>f(e,window.location.href))),t},_=(e,t)=>{const n=document.createElement("div");n.classList.add("acrobat-embedded-pdf-touch-point-context-menu-container");const o=b();n.appendChild(o);const d=p(e);return n.appendChild(d),o.addEventListener("click",(()=>A(n,o,e,t))),n},S=e=>{const n=document.createElement("div");n.classList.add("acrobat-embedded-pdf-touch-point-container-wrapper");const o=document.createElement("button");o.classList.add(t);const d=N(e);o.appendChild(d);const a=_(e,o);o.appendChild(a);const s=L(n,o);return o.appendChild(s),o.addEventListener("keydown",(e=>f(e,window.location.href))),n.appendChild(o),n},R=(e,t,n,o)=>{e.stopImmediatePropagation(),e.preventDefault(),c=!0,t.classList.add(d),C(o);const a=n.getBoundingClientRect();i=e.clientY-a.top;const s=E();M(s,n,t),document.documentElement.appendChild(s)},M=(e,t,n)=>{e?.addEventListener("mousemove",(e=>I(e,t))),r=()=>H(n,e),e?.addEventListener("mouseup",r),document.documentElement.addEventListener("mouseleave",r)},I=(e,t)=>{const n=U(e.clientY,t);t.style.top=`${n}px`,t.style.bottom="auto"},U=(e,t)=>{const n=e-i,o=window.innerHeight-t.offsetHeight-s;return Math.max(s,Math.min(o,n))},H=(e,t)=>{c&&(c=!1,e.classList.remove(d),t?.remove(),document.documentElement.removeEventListener("mouseleave",r),r=null)},j=async e=>{const t=S(e);document.documentElement.appendChild(t),l("DCBrowserExt:EmbeddedPDF:TouchPoint:Shown");const n=t?.getBoundingClientRect(),o=window?.frameElement?.getBoundingClientRect();chrome.runtime.sendMessage({main_op:"embedded-pdf-touch-point-added",frameId:e?.frameId,position:{top:n.top+o?.top,left:n.left+o?.left,right:n.right,bottom:n.bottom}})},O=async()=>{const e=await import(chrome.runtime.getURL("content_scripts/gsuite/fte-utils.js")),n=await chrome.runtime.sendMessage({main_op:"embedded-pdf-touch-point-config"}),o=document.getElementsByClassName(t),d=document.getElementsByClassName("acrobat-fte-tooltip");if(o?.length>0&&0===d?.length){const t=e.createFteTooltip(n?.fteToolTipStrings,"embeddedPDF");o[0].appendChild(t),sendAnalytics("DCBrowserExt:EmbeddedPDF:FTE:Shown");t.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{t?.remove(),sendAnalytics("DCBrowserExt:EmbeddedPDF:FTE:Closed")})),e?.updateFteToolTipCoolDown(n?.touchPointConfig?.tooltip,"embeddedPDFTouchPointFTEState"),t.addEventListener("mouseenter",(e=>{e.stopPropagation(),e.preventDefault()}),{capture:!0})}},$=async()=>{if(!e?.adobeCleanFontAdded){const t=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),n=new FontFace("AdobeClean-Regular",`url(${t})`);await n.load(),document.fonts.add(n),e.adobeCleanFontAdded=!0}},W=async()=>{const e=await chrome.runtime.sendMessage({main_op:"embedded-pdf-touch-point-config"});if(e?.enableEmbeddedPDFTouchPoint){if(e?.touchPointConfig?.blockedDomains?.includes(domain))return;if(l("DCBrowserExt:EmbeddedPDF:TouchPoint:Enabled"),window.innerHeight<280||window.innerWidth<320)return void l("DCBrowserExt:EmbeddedPDF:TouchPointSkipped:WidthHeight");await $(),j(e)}};chrome.runtime.onMessage.addListener((e=>{"add-fte-for-embedded-pdf-touch-point"===e?.type&&O()}));(()=>{if(document?.contentType?.includes("application/pdf")){const e=new URL(window.location.href),t=e?.hash?.includes("toolbar=0");domain=e.hostname;let n="Unknown";document.body?.childNodes?.length>0&&document.body.childNodes[0]?.getAttribute?.("src")?.startsWith("chrome-extension://dahenjhkoodjbpjheillcadbppiidmhp")?n="GoogleScholar":document.body?.childNodes?.length>0&&"about:blank"===document.body.childNodes[0]?.getAttribute?.("src")&&(n="NativeViewer"),m().then((()=>{l("DCBrowserExt:Viewer:Detected:EmbeddedPDF:IframeContentType",{eventContext:`${n}-${!t}`}),W()}))}})()}