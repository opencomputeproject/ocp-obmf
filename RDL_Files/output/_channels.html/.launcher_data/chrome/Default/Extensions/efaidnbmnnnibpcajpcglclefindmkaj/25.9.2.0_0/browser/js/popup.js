/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{events as e}from"../../common/analytics.js";import{util as t}from"./content-util.js";import{privateApi as a}from"./content-privateApi.js";import{dcLocalStorage as n}from"../../common/local-storage.js";import{isEdgeBrowser as o,updateExtUserState as i,isChromeViewerOpened as s}from"../../common/util.js";import{OptionPageActions as r,OptionsPageSource as c,OptionsPageToggles as l,POPUP_CONTEXT as d}from"../../common/constant.js";import{loggingApi as m}from"../../common/loggingApi.js";import{indexedDBScript as p}from"../../common/indexDB.js";await n.init();const u=n.getItem("appLocale");let g,h,f,_,I;const E=new Promise((e=>I=e)),w=$("#cdn-iframe"),A=await chrome.tabs.query({active:!0,lastFocusedWindow:!0}),b={contexts:{},register(e,t,a=!1,n){this.contexts[e]={containerId:t,isDefault:a},n&&n()},show(e){Object.values(this.contexts).forEach((e=>{const t=document.getElementById(e.containerId);t&&(t.style.display="none")}));const t=this.contexts[e];if(t){const e=document.getElementById(t.containerId);if(e)return e.style.display="block",!0}const a=Object.values(this.contexts).find((e=>e.isDefault));if(a){const t=document.getElementById(a.containerId);if(t)return t.style.display="block",console.warn(`Context "${e}" not found, falling back to default`),!1}return console.error("No default context found"),!1},init(){this.register(d.DEFAULT,"default-container",!0),this.register(d.LOCAL_FILE_COACHMARK,"local-file-coachmark-container",!1,y)}};async function y(){try{t.translateElements(".translate");const e=document.getElementById("local-file-animated-fte");e?e.style.backgroundImage="url(../images/LocalizedFte/en_US/fte_old.svg)":m.error({message:"Error in Local file animation coachmark on extension popup: FTE element not found"})}catch(e){m.error({message:"Error in Local file animation coachmark on extension popup",error:`initialize: Error in initialization: ${e}`})}finally{(new URL(A[0].url).searchParams.get("autoDismiss")||!1)&&setTimeout((()=>{window.close()}),1e4)}}function T(e){let t=e;return e.tab||(t={...e,tab:A[0]}),chrome.runtime.sendMessage(t)}function L(e,t){T({main_op:"analytics",analytics:[[e,t]]})}const C=e=>{try{const t=new URL(g),a=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return e===t.origin&&!!a.find((t=>t.test(e)))}catch(e){return!1}},D=async(e,t)=>{const a=w[0];if(a&&C(t)){const n=new Promise((e=>setTimeout((()=>e(!1)),1e5)));await Promise.race([E,n])&&a.contentWindow.postMessage(e,t)}};async function P(o){let i={main_op:"send-analytics"};o.target.checked&&n.setItem("viewer-enabled-source","ownership-consent"),n.getWithTTL("ownership-upgrade")&&!o.target.checked&&(t.analytics(i,e.USE_ACROBAT_VIEWER_DISABLED_DEFAULT_OWNERSHIP,{SOURCE:"trefoilMenu"}),t.analytics(i,e.USE_ACROBAT_VIEWER_DISABLED_DEFAULT_OWNERSHIP_EXPERIMENT,{SOURCE:"trefoilMenu",EXPERIMENT:n.getItem("experiment-ownership")}),n.removeItem("ownership-upgrade"),n.removeItem("defaultOwnerShipExperiment")),n.setItem("pdfViewer",`${o.target.checked}`),T({main_op:"changeDefaultViewershipForSurface",surfaceId:"gmail",isDefault:o.target.checked,source:"extensionPopup"}),T({main_op:"changeDefaultViewershipForSurface",surfaceId:"gdrive",isDefault:o.target.checked,source:"extensionPopup"});const s=o.target.checked?"enabled":"disabled";await a.setViewerState(s);try{n.removeItem("netAccAdT"),n.removeItem("netAcc"),n.removeItem("netAccCN")}catch(e){}o.target.checked?t.isEdge()?t.analytics(i,e.USE_ACROBAT_IN_EDGE_ENABLED):t.isChrome()&&t.analytics(i,e.USE_ACROBAT_IN_CHROME_ENABLED):t.isEdge()?t.analytics(i,e.USE_ACROBAT_IN_EDGE_DISABLED):t.isChrome()&&t.analytics(i,e.USE_ACROBAT_IN_CHROME_DISABLED),setTimeout((()=>{_?T({panel_op:"viewer_menu",reload_in_native:!0,tabId:A[0].id}):f&&chrome.tabs.reload(),T(i),T({panel_op:"options_page",requestType:r.OPTIONS_UPDATE_TOGGLE,toggleId:l.ViewerOwnershipTitle,toggleVal:o.target.checked}),t.isEdge()&&T({main_op:"pdfViewerChanged",value:`${o.target.checked}`})}),20)}function k(){L(e.TREFOIL_SETTINGS_ICON_CLICKED),n.setItem("optionsPageSource",c.EXTENSION_WIDGET_SETTINGS),chrome.runtime.openOptionsPage((t=>{chrome.runtime.lastError&&L(e.TREFOIL_SETTINGS_FAILED_TO_OPEN)}))}function O(){L(e.TREFOIL_ACROBAT_LABEL_CLICKED),T({main_op:"go_to_aonline",verb:"acrobat_label"})}window.addEventListener("message",(async e=>{if(!C(e.origin))return;const t={...e.data};switch(t.main_op){case"cdnReady":I(!0);break;case"go_to_aonline":T({...t,locale:u||n.getItem("locale")});break;case"convertToPDFPopupMenu":case"appendToExistingPDFPopupMenu":case"cancelWebpageConversion":case"clearStatus":case"open_converted_file":case"get-frictionless-url":case"timing_info":T(t);break;case"relay_to_content":t.main_op="external_msg",t.data=e.data,t.timeStamp=Date.now(),T(t);break;case"branding-clicked":O();break;case"settings-clicked":k();break;case"viewership-toggle":{const{checked:e}=t;P({target:{checked:e}});break}case"open-ai-assistant":window.close(),T(_?{main_op:"openViewerAIAssistant"}:{type:"open_side_panel",touchpoint:"TrefoilMenu"});break;case"add-webpage-to-project":window.close(),T(t);break;case"toggle-ai-assistant":n.setItem("enableGenAIFab",`${t.value}`);break;case"saveVisitorID":if(e.data.visitorID){const t=n.getItem("viewerVisitorID");n.setItem("viewerVisitorID",e.data.visitorID),t&&t!==e.data.visitorID&&L("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}break;case"openLocalFileThoughFilePicker":const a=document.createElement("input");a.type="file",a.accept=".pdf",a.style.display="none",document.body.appendChild(a),a.click(),a.onchange=async e=>{const t=e?.target?.files[0];if(!t)return void document.body.removeChild(a);const o=URL.createObjectURL(t),i=await t.arrayBuffer();n.getItem("cdnUrl")||T({main_op:"initializeViewerVariables"}),p.storeFileByHash(i,`chrome-extension://${chrome.runtime.id}/${o}`).then((()=>{const e={main_op:"openLocalFileThoughFilePicker"};e.file_name=t.name,e.fileURL=o,e.openLocalFileSource="ExtensionMenu:SelectFile",T(e)})).finally((()=>{document.body.removeChild(a)}))}}})),chrome.runtime.onMessage.addListener((e=>{switch(e.panel_op){case"status":{const{action:t}=e,a={type:0===t?"convertToPDFPopupMenu":"appendToExistingPDFPopupMenu",...e};D(a,h);break}case"load-frictionless":{const t=function(e,t){if(e.hide_spinner)return void w.removeClass("loader");const a=e.frictionless_uri;let o=new URL(a);if(t&&(t.locale=u||chrome.i18n.getMessage("@@ui_locale"),Object.keys(t).forEach((e=>{o.searchParams.append(e,t[e])}))),"false"===n.getItem("logAnalytics")){let e=o.toString();e=e.concat("&app!analytics=disable");try{o=new URL(e)}catch(e){o=""}}return T({iframe_call_time:Date.now(),main_op:"timing_info"}),o}(e,{verb:e.pdf_action,workflow:e.frictionless_workflow,dropzone2:"true"});t&&D({type:"frictionless-url",url:t.href},h);break}}})),async function(){!function(){const t=new URL(A[0].url).searchParams.get("context")||"default";b.init(),b.show(t),t===d.LOCAL_FILE_COACHMARK&&L(e.LOCAL_FILE_ANIMATION_COACHMARK_SHOWN)}();const a=performance.now();i(),L(e.EXT_MENU_ICON_CLICKED),$("#pdfOwnershipExploreAcrobat").text(t.getTranslation("pdfOwnershipExploreAcrobat")),$("#offlineModeTitle").text(t.getTranslation("popupNoConnection")),$("#offlineModeMessage").text(t.getTranslation("popupOfflineMessage"));const r="true"===n.getItem("pdfViewer");r||w.addClass("iframe-with-footer");const c=await T({main_op:"initialise-popup"}),{action:l,current_status:m,hostedURL:p,is_pdf:I,is_extension_url:E}=c;g=p,f=I,_=E,m&&(g=0===l?`${g}#/web-to-pdf`:`${g}#/add-webpage-to-pdf`);const y=new URL(g);h=y.origin;const C="false"!==n.getItem("logAnalytics"),v="false"!==n.getItem("ANALYTICS_OPT_IN_ADMIN");let S=n.getItem("viewer-locale");S||(S=n.getItem("locale")),y.searchParams.append("locale",u||S),y.searchParams.append("la",C&&v),y.searchParams.append("ao",n.getItem("aoem"));const F=n.getItem("installType")||"update",R=n.getItem("installSource");y.searchParams.append("version",`${chrome.runtime.getManifest().version}:${F}`),y.searchParams.append("installSource",R),y.searchParams.append("callingApp",chrome.runtime.id),n.getItem("enableExtMenuDarkMode")&&y.searchParams.append("theme",n.getItem("theme")||"auto");let M=!1;try{M=await chrome.tabs.sendMessage(A[0].id,{main_op:"shouldDisableGenAIForWebPagesTPs"})}catch(e){M=!0}y.searchParams.append("disableAskAIAssistant",M);const N=await async function(){let e=!1;try{e=!(!n.getItem("sidePanelRegistered")||o())&&(s(A[0].url)?await T({main_op:"isGenAIEligibleInCDN",activeTabId:A[0].id}):await chrome.tabs.sendMessage(A[0].id,{main_op:"shouldShowGenAIForWebPagesTPs"}))}catch(t){e=!1}return e}();y.searchParams.append("showAskAIAssistant",N),y.searchParams.append("genAIFabEnabled","true"===n.getItem("enableGenAIFab"));const x=await async function(){let e=!1;try{e=await chrome.tabs.sendMessage(A[0].id,{main_op:"shouldShowAddWebpageToProjectTouchpoint",tabURL:A[0].url})}catch(t){e=!1}return e}(),U=await async function(){try{return await T({main_op:"getFloodgateFlag",flag:"dc-cv-show-select-file",cachePurge:"NO_CALL"})}catch(e){return!1}}();y.searchParams.append("showAWPP",x),y.searchParams.append("showSF",U),U&&w.addClass("show-select-file");try{if(!(await fetch(y,{method:"HEAD"})).ok)throw new Error;w.attr("src",y.href),w[0].onload=()=>{const e=(performance.now()-a)/1e3,t=Number.parseFloat(e).toFixed(2);D({...c,isViewerEnabled:r,timeToLoad:t,type:"init"},h)}}catch{!function(){L(e.EXT_MENU_CDN_OFFLINE),w.remove();const t="true"===n.getItem("pdfViewer");$("#toggle-input").prop("checked",t),t||$("#footer").removeClass("hidden"),$(".settings-icon").click(k),$("#toggle-input").click(P),$("#branding").click(O),$("#offline-mode").removeClass("hidden")}()}}();